# æ€»ç»“

ç°åœ¨ä½ åº”è¯¥å¯¹ Git å¯ä»¥ä½œä»€ä¹ˆç›¸å½“äº†è§£äº†ï¼Œå¹¶ä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹ŸçŸ¥é“äº† Git æ˜¯å¦‚ä½•å®ç°çš„ã€‚æœ¬ç« è¦†ç›–äº†è®¸å¤š plumbing å‘½ä»¤ â”€â”€ è¿™äº›å‘½ä»¤æ¯”è¾ƒåº•å±‚ï¼Œä¸”æ¯”ä½ åœ¨æœ¬ä¹¦å…¶ä»–éƒ¨åˆ†å­¦åˆ°çš„ porcelain å‘½ä»¤è¦æ¥å¾—ç®€å•ã€‚ä»åº•å±‚äº†è§£ Git çš„å·¥ä½œåŸç†å¯ä»¥å¸®åŠ©ä½ æ›´å¥½åœ°ç†è§£ä¸ºä½• Git å®ç°äº†ç›®å‰çš„è¿™äº›åŠŸèƒ½ï¼Œä¹Ÿä½¿ä½ èƒ½å¤Ÿé’ˆå¯¹ä½ çš„å·¥ä½œæµå†™å‡ºè‡ªå·±çš„å·¥å…·å’Œè„šæœ¬ã€‚

Git ä½œä¸ºä¸€å¥— content-addressable çš„æ–‡ä»¶ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªéå¸¸å¼ºå¤§çš„å·¥å…·ï¼Œè€Œä¸ä»…ä»…åªæ˜¯ä¸€ä¸ª VCS ä¾›äººä½¿ç”¨ã€‚å¸Œæœ›å€ŸåŠ©äºä½ æ–°å­¦åˆ°çš„ Git å†…éƒ¨åŸç†çš„çŸ¥è¯†ï¼Œä½ å¯ä»¥å®ç°è‡ªå·±çš„æœ‰è¶£çš„åº”ç”¨ï¼Œå¹¶ä»¥æ›´é«˜çº§ä¾¿åˆ©çš„æ–¹å¼ä½¿ç”¨ Gitã€‚
·¥è¿è¡Œ auto gc å‘½ä»¤ï¼š

	$ git gc --auto

å†æ¬¡å¼ºè°ƒï¼Œè¿™ä¸ªå‘½ä»¤ä¸€èˆ¬ä»€ä¹ˆéƒ½ä¸å¹²ã€‚å¦‚æœæœ‰ 7,000 ä¸ªå·¦å³çš„æ¾æ•£å¯¹è±¡æˆ–æ˜¯ 50 ä¸ªä»¥ä¸Šçš„ packfileï¼ŒGit æ‰ä¼šçœŸæ­£è°ƒç”¨ gc å‘½ä»¤ã€‚å¯èƒ½é€šè¿‡ä¿®æ”¹é…ç½®ä¸­çš„ `gc.auto` å’Œ `gc.autopacklimit` æ¥è°ƒæ•´è¿™ä¸¤ä¸ªé˜ˆå€¼ã€‚

`gc` è¿˜ä¼šå°†æ‰€æœ‰å¼•ç”¨ (references) å¹¶å…¥ä¸€ä¸ªå•ç‹¬æ–‡ä»¶ã€‚å‡è®¾ä»“åº“ä¸­åŒ…å«ä»¥ä¸‹åˆ†æ”¯å’Œæ ‡ç­¾ï¼š

	$ find .git/refs -type f
	.git/refs/heads/experiment
	.git/refs/heads/master
	.git/refs/tags/v1.0
	.git/refs/tags/v1.1

è¿™æ—¶å¦‚æœè¿è¡Œ `git gc`, `refs` ä¸‹çš„æ‰€æœ‰æ–‡ä»¶éƒ½ä¼šæ¶ˆå¤±ã€‚Git ä¼šå°†è¿™äº›æ–‡ä»¶æŒªåˆ° `.git/packed-refs` æ–‡ä»¶ä¸­å»ä»¥æé«˜æ•ˆç‡ï¼Œè¯¥æ–‡ä»¶æ˜¯è¿™ä¸ªæ ·å­çš„ï¼š

	$ cat .git/packed-refs
	# pack-refs with: peeled
	cac0cab538b970a37ea1e769cbbde608743bc96d refs/heads/experiment
	ab1afef80fac8e34258ff41fc1b867c702daa24b refs/heads/master
	cac0cab538b970a37ea1e769cbbde608743bc96d refs/tags/v1.0
	9585191f37f7b0fb9444f35a9bf50de191beadc2 refs/tags/v1.1
	^1a410efbd13591db07496601ebc7a059dd55cfe9

å½“æ›´æ–°ä¸€ä¸ªå¼•ç”¨æ—¶ï¼ŒGit ä¸ä¼šä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼Œè€Œæ˜¯åœ¨ `refs/heads` ä¸‹å†™å…¥ä¸€ä¸ªæ–°æ–‡ä»¶ã€‚å½“æŸ¥æ‰¾ä¸€ä¸ªå¼•ç”¨çš„ SHA æ—¶ï¼ŒGit é¦–å…ˆåœ¨ `refs` ç›®å½•ä¸‹æŸ¥æ‰¾ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™åˆ° `packed-refs` æ–‡ä»¶ä¸­å»æŸ¥æ‰¾ã€‚å› æ­¤å¦‚æœåœ¨ `refs` ç›®å½•ä¸‹æ‰¾ä¸åˆ°ä¸€ä¸ªå¼•ç”¨ï¼Œè¯¥å¼•ç”¨å¯èƒ½å­˜åˆ° `packed-refs` æ–‡ä»¶ä¸­å»äº†ã€‚

è¯·ç•™æ„æ–‡ä»¶æœ€åä»¥ `^` å¼€å¤´çš„é‚£ä¸€è¡Œã€‚è¿™è¡¨ç¤ºè¯¥è¡Œä¸Šä¸€è¡Œçš„é‚£ä¸ªæ ‡ç­¾æ˜¯ä¸€ä¸ª annotated æ ‡ç­¾ï¼Œè€Œè¯¥è¡Œæ­£æ˜¯é‚£ä¸ªæ ‡ç­¾æ‰€æŒ‡å‘çš„ commit ã€‚

## æ•°æ®æ¢å¤

åœ¨ä½¿ç”¨ Git çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ—¶ä¼šä¸å°å¿ƒä¸¢å¤± commit ä¿¡æ¯ã€‚è¿™ä¸€èˆ¬å‡ºç°åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼šå¼ºåˆ¶åˆ é™¤äº†ä¸€ä¸ªåˆ†æ”¯è€Œååˆæƒ³é‡æ–°ä½¿ç”¨è¿™ä¸ªåˆ†æ”¯ï¼Œhard-reset äº†ä¸€ä¸ªåˆ†æ”¯ä»è€Œä¸¢å¼ƒäº†åˆ†æ”¯çš„éƒ¨åˆ† commitã€‚å¦‚æœè¿™çœŸçš„å‘ç”Ÿäº†ï¼Œæœ‰ä»€ä¹ˆåŠæ³•æŠŠä¸¢å¤±çš„ commit æ‰¾å›æ¥å‘¢ï¼Ÿ

ä¸‹é¢çš„ç¤ºä¾‹æ¼”ç¤ºäº†å¯¹ test ä»“åº“ä¸»åˆ†æ”¯è¿›è¡Œ hard-reset åˆ°ä¸€ä¸ªè€ç‰ˆæœ¬çš„ commit çš„æ“ä½œï¼Œç„¶åæ¢å¤ä¸¢å¤±çš„ commit ã€‚é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹å½“å‰çš„ä»“åº“çŠ¶æ€ï¼š

	$ git log --pretty=oneline
	ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
	484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

æ¥ç€å°† `master` åˆ†æ”¯ç§»å›è‡³ä¸­é—´çš„ä¸€ä¸ª commitï¼š

	$ git reset --hard 1a410efbd13591db07496601ebc7a059dd55cfe9
	HEAD is now at 1a410ef third commit
	$ git log --pretty=oneline
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

è¿™æ ·å°±ä¸¢å¼ƒäº†æœ€æ–°çš„ä¸¤ä¸ª commit â”€â”€ åŒ…å«è¿™ä¸¤ä¸ª commit çš„åˆ†æ”¯ä¸å­˜åœ¨äº†ã€‚ç°åœ¨è¦åšçš„æ˜¯æ‰¾å‡ºæœ€æ–°çš„é‚£ä¸ª commit çš„ SHAï¼Œç„¶åæ·»åŠ ä¸€ä¸ªæŒ‡å®ƒå®ƒçš„åˆ†æ”¯ã€‚å…³é”®åœ¨äºæ‰¾å‡ºæœ€æ–°çš„ commit çš„ SHA â”€â”€ ä½ ä¸å¤§å¯èƒ½è®°ä½äº†è¿™ä¸ª SHAï¼Œæ˜¯å§ï¼Ÿ

é€šå¸¸æœ€å¿«æ·çš„åŠæ³•æ˜¯ä½¿ç”¨ `git reflog` å·¥å…·ã€‚å½“ä½  (åœ¨ä¸€ä¸ªä»“åº“ä¸‹) å·¥ä½œæ—¶ï¼ŒGit ä¼šåœ¨ä½ æ¯æ¬¡ä¿®æ”¹äº† HEAD æ—¶æ‚„æ‚„åœ°å°†æ”¹åŠ¨è®°å½•ä¸‹æ¥ã€‚å½“ä½ æäº¤æˆ–ä¿®æ”¹åˆ†æ”¯æ—¶ï¼Œreflog å°±ä¼šæ›´æ–°ã€‚`git update-ref` å‘½ä»¤ä¹Ÿå¯ä»¥æ›´æ–° reflogï¼Œè¿™æ˜¯åœ¨æœ¬ç« å‰é¢çš„ "Git References" éƒ¨åˆ†æˆ‘ä»¬ä½¿ç”¨è¯¥å‘½ä»¤è€Œä¸æ˜¯æ‰‹å·¥å°† SHA å€¼å†™å…¥ ref æ–‡ä»¶çš„ç†ç”±ã€‚ä»»ä½•æ—¶é—´è¿è¡Œ `git reflog` å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰çš„çŠ¶æ€ï¼š

	$ git reflog
	1a410ef HEAD@{0}: 1a410efbd13591db07496601ebc7a059dd55cfe9: updating HEAD
	ab1afef HEAD@{1}: ab1afef80fac8e34258ff41fc1b867c702daa24b: updating HEAD

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬ç­¾å‡ºçš„ä¸¤ä¸ª commit ï¼Œä½†æ²¡æœ‰æ›´å¤šçš„ç›¸å…³ä¿¡æ¯ã€‚è¿è¡Œ `git log -g` ä¼šè¾“å‡º reflog çš„æ­£å¸¸æ—¥å¿—ï¼Œä»è€Œæ˜¾ç¤ºæ›´å¤šæœ‰ç”¨ä¿¡æ¯ï¼š

	$ git log -g
	commit 1a410efbd13591db07496601ebc7a059dd55cfe9
	Reflog: HEAD@{0} (Scott Chacon <schacon@gmail.com>)
	Reflog message: updating HEAD
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:22:37 2009 -0700

	    third commit

	commit ab1afef80fac8e34258ff41fc1b867c702daa24b
	Reflog: HEAD@{1} (Scott Chacon <schacon@gmail.com>)
	Reflog message: updating HEAD
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:15:24 2009 -0700

	     modified repo a bit

çœ‹èµ·æ¥å¼„ä¸¢äº†çš„ commit æ˜¯åº•ä¸‹é‚£ä¸ªï¼Œè¿™æ ·åœ¨é‚£ä¸ª commit ä¸Šåˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯å°±èƒ½æŠŠå®ƒæ¢å¤è¿‡æ¥ã€‚æ¯”æ–¹è¯´ï¼Œå¯ä»¥åœ¨é‚£ä¸ª commit (ab1afef) ä¸Šåˆ›å»ºä¸€ä¸ªåä¸º `recover-branch` çš„åˆ†æ”¯ï¼š

	$ git branch recover-branch ab1afef
	$ git log --pretty=oneline recover-branch
	ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
	484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

é…·ï¼è¿™æ ·æœ‰äº†ä¸€ä¸ªè·ŸåŸæ¥ `master` ä¸€æ ·çš„ `recover-branch` åˆ†æ”¯ï¼Œæœ€æ–°çš„ä¸¤ä¸ª commit åˆæ‰¾å›æ¥äº†ã€‚æ¥ç€ï¼Œå‡è®¾å¼•èµ· commit ä¸¢å¤±çš„åŸå› å¹¶æ²¡æœ‰è®°å½•åœ¨ reflog ä¸­ â”€â”€ å¯ä»¥é€šè¿‡åˆ é™¤ `recover-branch` å’Œ reflog æ¥æ¨¡æ‹Ÿè¿™ç§æƒ…å†µã€‚è¿™æ ·æœ€æ–°çš„ä¸¤ä¸ª commit ä¸ä¼šè¢«ä»»ä½•ä¸œè¥¿å¼•ç”¨åˆ°ï¼š

	$ git branch -D recover-branch
	$ rm -Rf .git/logs/

å› ä¸º reflog æ•°æ®æ˜¯ä¿å­˜åœ¨ `.git/logs/` ç›®å½•ä¸‹çš„ï¼Œè¿™æ ·å°±æ²¡æœ‰ reflog äº†ã€‚ç°åœ¨è¦æ€æ ·æ¢å¤ commit å‘¢ï¼ŸåŠæ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨ `git fsck` å·¥å…·ï¼Œè¯¥å·¥å…·ä¼šæ£€æŸ¥ä»“åº“çš„æ•°æ®å®Œæ•´æ€§ã€‚å¦‚æœæŒ‡å®š `--full` é€‰é¡¹ï¼Œè¯¥å‘½ä»¤æ˜¾ç¤ºæ‰€æœ‰æœªè¢«å…¶ä»–å¯¹è±¡å¼•ç”¨ (æŒ‡å‘) çš„æ‰€æœ‰å¯¹è±¡ï¼š

	$ git fsck --full
	dangling blob d670460b4b4aece5915caf5c68d12f560a9fe3e4
	dangling commit ab1afef80fac8e34258ff41fc1b867c702daa24b
	dangling tree aea790b9a58f6cf6f2804eeac9f0abbe9631e4c9
	dangling blob 7108f7ecb345ee9d0084193f147cdad4d2998293

æœ¬ä¾‹ä¸­ï¼Œå¯ä»¥ä» dangling commit æ‰¾åˆ°ä¸¢å¤±äº†çš„ commitã€‚ç”¨ç›¸åŒçš„æ–¹æ³•å°±å¯ä»¥æ¢å¤å®ƒï¼Œå³åˆ›å»ºä¸€ä¸ªæŒ‡å‘è¯¥ SHA çš„åˆ†æ”¯ã€‚

## ç§»é™¤å¯¹è±¡

Git æœ‰è®¸å¤šè¿‡äººä¹‹å¤„ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªåŠŸèƒ½æœ‰æ—¶å´ä¼šå¸¦æ¥é—®é¢˜ï¼š`git clone` ä¼šå°†åŒ…å«æ¯ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰å†å²ç‰ˆæœ¬çš„æ•´ä¸ªé¡¹ç›®ä¸‹è½½ä¸‹æ¥ã€‚å¦‚æœé¡¹ç›®åŒ…å«çš„ä»…ä»…æ˜¯æºä»£ç çš„è¯è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆåå¤„ï¼Œæ¯•ç«Ÿ Git å¯ä»¥éå¸¸é«˜æ•ˆåœ°å‹ç¼©æ­¤ç±»æ•°æ®ã€‚ä¸è¿‡å¦‚æœæœ‰äººåœ¨æŸä¸ªæ—¶åˆ»å¾€é¡¹ç›®ä¸­æ·»åŠ äº†ä¸€ä¸ªéå¸¸å¤§çš„æ–‡ä»¶ï¼Œé‚£ä»¬å³ä¾¿ä»–åœ¨åæ¥çš„æäº¤ä¸­å°†æ­¤æ–‡ä»¶åˆ æ‰äº†ï¼Œæ‰€æœ‰çš„ç­¾å‡ºéƒ½ä¼šä¸‹è½½è¿™ä¸ªå¤§æ–‡ä»¶ã€‚å› ä¸ºå†å²è®°å½•ä¸­å¼•ç”¨äº†è¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒä¼šä¸€ç›´å­˜åœ¨ç€ã€‚

å½“ä½ å°† Subversion æˆ– Perforce ä»“åº“è½¬æ¢å¯¼å…¥è‡³ Git æ—¶è¿™ä¼šæˆä¸ºä¸€ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ã€‚åœ¨æ­¤ç±»ç³»ç»Ÿä¸­ï¼Œ(ç­¾å‡ºæ—¶) ä¸ä¼šä¸‹è½½æ•´ä¸ªä»“åº“å†å²ï¼Œæ‰€ä»¥è¿™ç§æƒ…å½¢ä¸å¤§ä¼šæœ‰ä¸è‰¯åæœã€‚å¦‚æœä½ ä»å…¶ä»–ç³»ç»Ÿå¯¼å…¥äº†ä¸€ä¸ªä»“åº“ï¼Œæˆ–æ˜¯å‘è§‰ä¸€ä¸ªä»“åº“çš„å°ºå¯¸è¿œè¶…å‡ºé¢„è®¡ï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•æ‰¾åˆ°å¹¶ç§»é™¤å¤§ (å°ºå¯¸) å¯¹è±¡ã€‚

è­¦å‘Šï¼šæ­¤æ–¹æ³•ä¼šç ´åæäº¤å†å²ã€‚ä¸ºäº†ç§»é™¤å¯¹ä¸€ä¸ªå¤§æ–‡ä»¶çš„å¼•ç”¨ï¼Œä»æœ€æ—©åŒ…å«è¯¥å¼•ç”¨çš„ tree å¯¹è±¡å¼€å§‹ä¹‹åçš„æ‰€æœ‰ commit å¯¹è±¡éƒ½ä¼šè¢«é‡å†™ã€‚å¦‚æœåœ¨åˆšå¯¼å…¥ä¸€ä¸ªä»“åº“å¹¶åœ¨å…¶ä»–äººåœ¨æ­¤åŸºç¡€ä¸Šå¼€å§‹å·¥ä½œä¹‹å‰è¿™ä¹ˆåšï¼Œé‚£æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ â”€â”€ å¦åˆ™ä½ ä¸å¾—ä¸é€šçŸ¥æ‰€æœ‰åä½œè€… (è´¡çŒ®è€…) å»è¡åˆä½ æ–°ä¿®æ”¹çš„ commit ã€‚

ä¸ºäº†æ¼”ç¤ºè¿™ç‚¹ï¼Œå¾€ test ä»“åº“ä¸­åŠ å…¥ä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œç„¶ååœ¨ä¸‹æ¬¡æäº¤æ—¶å°†å®ƒåˆ é™¤ï¼Œæ¥ç€æ‰¾åˆ°å¹¶å°†è¿™ä¸ªæ–‡ä»¶ä»ä»“åº“ä¸­æ°¸ä¹…åˆ é™¤ã€‚é¦–å…ˆï¼ŒåŠ ä¸€ä¸ªå¤§æ–‡ä»¶è¿›å»ï¼š

	$ curl http://kernel.org/pub/software/scm/git/git-1.6.3.1.tar.bz2 > git.tbz2
	$ git add git.tbz2
	$ git commit -am 'added git tarball'
	[master 6df7640] added git tarball
	 1 files changed, 0 insertions(+), 0 deletions(-)
	 create mode 100644 git.tbz2

å–”ï¼Œä½ å¹¶ä¸æƒ³å¾€é¡¹ç›®ä¸­åŠ è¿›ä¸€ä¸ªè¿™ä¹ˆå¤§çš„ tar åŒ…ã€‚æœ€åè¿˜æ˜¯å»æ‰å®ƒï¼š

	$ git rm git.tbz2
	rm 'git.tbz2'
	$ git commit -m 'oops - removed large tarball'
	[master da3f30d] oops - removed large tarball
	 1 files changed, 0 insertions(+), 0 deletions(-)
	 delete mode 100644 git.tbz2

å¯¹ä»“åº“è¿›è¡Œ `gc` æ“ä½œï¼Œå¹¶æŸ¥çœ‹å ç”¨äº†ç©ºé—´ï¼š

	$ git gc
	Counting objects: 21, done.
	Delta compression using 2 threads.
	Compressing objects: 100% (16/16), done.
	Writing objects: 100% (21/21), done.
	Total 21 (delta 3), reused 15 (delta 1)

å¯ä»¥è¿è¡Œ `count-objects` ä»¥æŸ¥çœ‹ä½¿ç”¨äº†å¤šå°‘ç©ºé—´ï¼š

	$ git count-objects -v
	count: 4
	size: 16
	in-pack: 21
	packs: 1
	size-pack: 2016
	prune-packable: 0
	garbage: 0

`size-pack` æ˜¯ä»¥åƒå­—èŠ‚ä¸ºå•ä½è¡¨ç¤ºçš„ packfiles çš„å¤§å°ï¼Œå› æ­¤å·²ç»ä½¿ç”¨äº† 2MB ã€‚è€Œåœ¨è¿™æ¬¡æäº¤ä¹‹å‰ä»…ç”¨äº† 2K å·¦å³ â”€â”€ æ˜¾ç„¶åœ¨è¿™æ¬¡æäº¤æ—¶åˆ é™¤æ–‡ä»¶å¹¶æ²¡æœ‰çœŸæ­£å°†å…¶ä»å†å²è®°å½•ä¸­åˆ é™¤ã€‚æ¯å½“æœ‰äººå¤åˆ¶è¿™ä¸ªä»“åº“å»å–å¾—è¿™ä¸ªå°é¡¹ç›®æ—¶ï¼Œéƒ½ä¸å¾—ä¸å¤åˆ¶æ‰€æœ‰ 2MB æ•°æ®ï¼Œè€Œè¿™ä»…ä»…å› ä¸ºä½ æ›¾ç»ä¸å°å¿ƒåŠ äº†ä¸ªå¤§æ–‡ä»¶ã€‚å½“æˆ‘ä»¬æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

é¦–å…ˆè¦æ‰¾å‡ºè¿™ä¸ªæ–‡ä»¶ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ çŸ¥é“æ˜¯å“ªä¸ªæ–‡ä»¶ã€‚å‡è®¾ä½ å¹¶ä¸çŸ¥é“è¿™ä¸€ç‚¹ï¼Œè¦å¦‚ä½•æ‰¾å‡ºå“ªä¸ª (äº›) æ–‡ä»¶å ç”¨äº†è¿™ä¹ˆå¤šçš„ç©ºé—´ï¼Ÿå¦‚æœè¿è¡Œ `git gc`ï¼Œæ‰€æœ‰å¯¹è±¡ä¼šå­˜å…¥ä¸€ä¸ª packfile æ–‡ä»¶ï¼›è¿è¡Œå¦ä¸€ä¸ªåº•å±‚å‘½ä»¤ `git verify-pack` ä»¥è¯†åˆ«å‡ºå¤§å¯¹è±¡ï¼Œå¯¹è¾“å‡ºçš„ç¬¬ä¸‰åˆ—ä¿¡æ¯å³æ–‡ä»¶å¤§å°è¿›è¡Œæ’åºï¼Œè¿˜å¯ä»¥å°†è¾“å‡ºå®šå‘åˆ° `tail` å‘½ä»¤ï¼Œå› ä¸ºä½ åªå…³å¿ƒæ’åœ¨æœ€åçš„é‚£å‡ ä¸ªæœ€å¤§çš„æ–‡ä»¶ï¼š

	$ git verify-pack -v .git/objects/pack/pack-3f8c0...bb.idx | sort -k 3 -n | tail -3
	e3f094f522629ae358806b17daf78246c27c007b blob   1486 734 4667
	05408d195263d853f09dca71d55116663690c27c blob   12908 3478 1189
	7a9eb2fba2b1811321254ac360970fc169ba2330 blob   2056716 2056872 5401

æœ€åº•ä¸‹é‚£ä¸ªå°±æ˜¯é‚£ä¸ªå¤§æ–‡ä»¶ï¼š2MB ã€‚è¦æŸ¥çœ‹è¿™åˆ°åº•æ˜¯å“ªä¸ªæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ 7 ç« ä¸­å·²ç»ç®€å•ä½¿ç”¨è¿‡çš„ `rev-list` å‘½ä»¤ã€‚è‹¥ç»™ `rev-list` å‘½ä»¤ä¼ å…¥ `--objects` é€‰é¡¹ï¼Œå®ƒä¼šåˆ—å‡ºæ‰€æœ‰ commit SHA å€¼ï¼Œblob SHA å€¼åŠç›¸åº”çš„æ–‡ä»¶è·¯å¾„ã€‚å¯ä»¥è¿™æ ·æŸ¥çœ‹ blob çš„æ–‡ä»¶åï¼š

	$ git rev-list --objects --all | grep 7a9eb2fb
	7a9eb2fba2b1811321254ac360970fc169ba2330 git.tbz2

æ¥ä¸‹æ¥è¦å°†è¯¥æ–‡ä»¶ä»å†å²è®°å½•çš„æ‰€æœ‰ tree ä¸­ç§»é™¤ã€‚å¾ˆå®¹æ˜“æ‰¾å‡ºå“ªäº› commit ä¿®æ”¹äº†è¿™ä¸ªæ–‡ä»¶ï¼š

	$ git log --pretty=oneline --branches -- git.tbz2
	da3f30d019005479c99eb4c3406225613985a1db oops - removed large tarball
	6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 added git tarball

å¿…é¡»é‡å†™ä» `6df76` å¼€å§‹çš„æ‰€æœ‰ commit æ‰èƒ½å°†æ–‡ä»¶ä» Git å†å²ä¸­å®Œå…¨ç§»é™¤ã€‚è¿™ä¹ˆåšéœ€è¦ç”¨åˆ°ç¬¬ 6 ç« ä¸­ç”¨è¿‡çš„ `filter-branch` å‘½ä»¤ï¼š

	$ git filter-branch --index-filter \
	   'git rm --cached --ignore-unmatch git.tbz2' -- 6df7640^..
	Rewrite 6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 (1/2)rm 'git.tbz2'
	Rewrite da3f30d019005479c99eb4c3406225613985a1db (2/2)
	Ref 'refs/heads/master' was rewritten

`--index-filter` é€‰é¡¹ç±»ä¼¼äºç¬¬ 6 ç« ä¸­ä½¿ç”¨çš„ `--tree-filter` é€‰é¡¹ï¼Œä½†è¿™é‡Œä¸æ˜¯ä¼ å…¥ä¸€ä¸ªå‘½ä»¤å»ä¿®æ”¹ç£ç›˜ä¸Šç­¾å‡ºçš„æ–‡ä»¶ï¼Œè€Œæ˜¯ä¿®æ”¹æš‚å­˜åŒºåŸŸæˆ–ç´¢å¼•ã€‚ä¸èƒ½ç”¨ `rm file` å‘½ä»¤æ¥åˆ é™¤ä¸€ä¸ªç‰¹å®šæ–‡ä»¶ï¼Œè€Œæ˜¯å¿…é¡»ç”¨ `git rm --cached` æ¥åˆ é™¤å®ƒ â”€â”€ å³ä»ç´¢å¼•è€Œä¸æ˜¯ç£ç›˜åˆ é™¤å®ƒã€‚è¿™æ ·åšæ˜¯å‡ºäºé€Ÿåº¦è€ƒè™‘ â”€â”€ ç”±äº Git åœ¨è¿è¡Œä½ çš„ filter ä¹‹å‰æ— éœ€å°†æ‰€æœ‰ç‰ˆæœ¬ç­¾å‡ºåˆ°ç£ç›˜ä¸Šï¼Œè¿™ä¸ªæ“ä½œä¼šå¿«å¾—å¤šã€‚ä¹Ÿå¯ä»¥ç”¨ `--tree-filter` æ¥å®Œæˆç›¸åŒçš„æ“ä½œã€‚`git rm` çš„ `--ignore-unmatch` é€‰é¡¹æŒ‡å®šå½“ä½ è¯•å›¾åˆ é™¤çš„å†…å®¹å¹¶ä¸å­˜åœ¨æ—¶ä¸æ˜¾ç¤ºé”™è¯¯ã€‚æœ€åï¼Œå› ä¸ºä½ æ¸…æ¥šé—®é¢˜æ˜¯ä»å“ªä¸ª commit å¼€å§‹çš„ï¼Œä½¿ç”¨ `filter-branch` é‡å†™è‡ª `6df7640` è¿™ä¸ª commit å¼€å§‹çš„æ‰€æœ‰å†å²è®°å½•ã€‚ä¸è¿™ä¹ˆåšçš„è¯ä¼šé‡å†™æ‰€æœ‰å†å²è®°å½•ï¼ŒèŠ±è´¹ä¸å¿…è¦çš„æ›´å¤šæ—¶é—´ã€‚

ç°åœ¨å†å²è®°å½•ä¸­å·²ç»ä¸åŒ…å«å¯¹é‚£ä¸ªæ–‡ä»¶çš„å¼•ç”¨äº†ã€‚ä¸è¿‡ reflog ä»¥åŠè¿è¡Œ `filter-branch` æ—¶ Git å¾€ `.git/refs/original` æ·»åŠ çš„ä¸€äº› refs ä¸­ä»æœ‰å¯¹å®ƒçš„å¼•ç”¨ï¼Œå› æ­¤éœ€è¦å°†è¿™äº›å¼•ç”¨åˆ é™¤å¹¶å¯¹ä»“åº“è¿›è¡Œ repack æ“ä½œã€‚åœ¨è¿›è¡Œ repack å‰éœ€è¦å°†æ‰€æœ‰å¯¹è¿™äº› commits çš„å¼•ç”¨å»é™¤ï¼š

	$ rm -Rf .git/refs/original
	$ rm -Rf .git/logs/
	$ git gc
	Counting objects: 19, done.
	Delta compression using 2 threads.
	Compressing objects: 100% (14/14), done.
	Writing objects: 100% (19/19), done.
	Total 19 (delta 3), reused 16 (delta 1)

çœ‹ä¸€ä¸‹èŠ‚çœäº†å¤šå°‘ç©ºé—´ã€‚

	$ git count-objects -v
	count: 8
	size: 2040
	in-pack: 19
	packs: 1
	size-pack: 7
	prune-packable: 0
	garbage: 0

repack åä»“åº“çš„å¤§å°å‡å°åˆ°äº† 7K ï¼Œè¿œå°äºä¹‹å‰çš„ 2MB ã€‚ä» size å€¼å¯ä»¥çœ‹å‡ºå¤§æ–‡ä»¶å¯¹è±¡è¿˜åœ¨æ¾æ•£å¯¹è±¡ä¸­ï¼Œå…¶å®å¹¶æ²¡æœ‰æ¶ˆå¤±ï¼Œä¸è¿‡è¿™æ²¡æœ‰å…³ç³»ï¼Œé‡è¦çš„æ˜¯åœ¨å†è¿›è¡Œæ¨é€æˆ–å¤åˆ¶ï¼Œè¿™ä¸ªå¯¹è±¡ä¸ä¼šå†ä¼ é€å‡ºå»ã€‚å¦‚æœçœŸçš„è¦å®Œå…¨æŠŠè¿™ä¸ªå¯¹è±¡åˆ é™¤ï¼Œå¯ä»¥è¿è¡Œ `git prune --expire` å‘½ä»¤ã€‚
