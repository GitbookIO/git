# Git ç‰©ä»¶

Git æ˜¯ä¸€å¥—å…§å®¹å®šå€æª”æ¡ˆç³»çµ±ã€‚å¾ˆä¸éŒ¯ã€‚ä¸éé€™æ˜¯ä»€éº¼æ„æ€å‘¢ï¼Ÿ
é€™ç¨®èªªæ³•çš„æ„æ€æ˜¯ï¼Œå¾å…§éƒ¨ä¾†çœ‹ï¼ŒGit æ˜¯ç°¡å–®çš„ key-value è³‡æ–™å„²å­˜ã€‚å®ƒå…è¨±æ’å…¥ä»»æ„é¡å‹çš„å…§å®¹ï¼Œä¸¦æœƒå›å‚³ä¸€å€‹éµå€¼ï¼Œé€šéè©²éµå€¼å¯ä»¥åœ¨ä»»ä½•æ™‚å€™å†å–å‡ºè©²å…§å®¹ã€‚å¯ä»¥é€šéåº•å±¤å‘½ä»¤ `hash-object` ä¾†ç¤ºç¯„é€™é»ï¼Œå‚³ä¸€äº›è³‡æ–™çµ¦è©²å‘½ä»¤ï¼Œå®ƒæœƒå°‡è³‡æ–™ä¿å­˜åœ¨ `.git` ç›®éŒ„ä¸¦å›å‚³è¡¨ç¤ºé€™äº›è³‡æ–™çš„éµå€¼ã€‚é¦–å…ˆåˆä½¿åŒ–ä¸€å€‹ Git å€‰åº«ä¸¦ç¢ºèª `objects` ç›®éŒ„æ˜¯ç©ºçš„ï¼š 

	$ mkdir test
	$ cd test
	$ git init
	Initialized empty Git repository in /tmp/test/.git/
	$ find .git/objects
	.git/objects
	.git/objects/info
	.git/objects/pack
	$ find .git/objects -type f
	$

Git åˆå§‹åŒ–äº† `objects ç›®éŒ„`ï¼ŒåŒæ™‚åœ¨è©²ç›®éŒ„ä¸‹å‰µå»ºäº† `pack` å’Œ `info` å­ç›®éŒ„ï¼Œä½†æ˜¯è©²ç›®éŒ„ä¸‹æ²’æœ‰å…¶ä»–å¸¸è¦æª”ã€‚æˆ‘å€‘å¾€é€™å€‹ Git è³‡æ–™åº«è£¡å„²å­˜ä¸€äº›æ–‡æœ¬ï¼š

	$ echo 'test content' | git hash-object -w --stdin
	d670460b4b4aece5915caf5c68d12f560a9fe3e4

åƒæ•¸ `-w` æŒ‡ç¤º `hash-object` å‘½ä»¤å„²å­˜ (è³‡æ–™) ç‰©ä»¶ï¼Œè‹¥ä¸æŒ‡å®šé€™å€‹åƒæ•¸è©²å‘½ä»¤åƒ…åƒ…å›å‚³éµå€¼ã€‚`--stdin` æŒ‡å®šå¾æ¨™æº–è¼¸å…¥è£ç½® (stdin) ä¾†è®€å–å…§å®¹ï¼Œè‹¥ä¸æŒ‡å®šé€™å€‹åƒæ•¸ï¼Œ`hash-object` å°±éœ€è¦æŒ‡å®šä¸€å€‹è¦å„²å­˜çš„æª”æ¡ˆè·¯å¾‘ã€‚è©²å‘½ä»¤è¼¸å‡ºé•·åº¦ç‚º 40 å€‹å­—å…ƒçš„æ ¡é©—å’Œ(checksum hash)ã€‚é€™æ˜¯å€‹ SHA-1 é›œæ¹Šå€¼â”€â”€å…¶å€¼ç‚ºè¦å„²å­˜çš„è³‡æ–™åŠ ä¸Šä½ é¦¬ä¸Šæœƒç­è§£åˆ°çš„ä¸€ç¨®é ­è³‡è¨Š(header)çš„æ ¡é©—å’Œã€‚ç¾åœ¨å¯ä»¥æŸ¥çœ‹åˆ° Git å·²ç¶“å„²å­˜äº†è³‡æ–™ï¼š 

	$ find .git/objects -type f
	.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4

å¯ä»¥åœ¨ `objects` ç›®éŒ„ä¸‹çœ‹åˆ°ä¸€å€‹æª”ã€‚é€™ä¾¿æ˜¯ Git å„²å­˜è³‡æ–™å…§å®¹çš„æ–¹å¼â”€â”€ç‚ºæ¯ä»½å…§å®¹ç”Ÿæˆä¸€å€‹æª”ï¼Œå–å¾—è©²å…§å®¹èˆ‡é ­è³‡è¨Šçš„ SHA-1 æ ¡é©—å’Œï¼Œå‰µå»ºä»¥è©²æ ¡é©—å’Œå‰å…©å€‹å­—å…ƒç‚ºåç¨±çš„å­ç›®éŒ„ï¼Œä¸¦ä»¥ (æ ¡é©—å’Œ) å‰©ä¸‹ 38 å€‹å­—å…ƒç‚ºæª”å‘½å (ä¿å­˜è‡³å­ç›®éŒ„ä¸‹)ã€‚ 

é€šé `cat-file` å‘½ä»¤å¯ä»¥å°‡è³‡æ–™å…§å®¹å–å›ã€‚è©²å‘½ä»¤æ˜¯æŸ¥çœ‹ Git å°è±¡çš„ç‘å£«è»åˆ€ã€‚å‚³å…¥ `-p` åƒæ•¸å¯ä»¥è®“ `cat-file` å‘½ä»¤è¼¸å‡ºè³‡æ–™å…§å®¹çš„é¡å‹ï¼š 

	$ git cat-file -p d670460b4b4aece5915caf5c68d12f560a9fe3e4
	test content

å¯ä»¥å¾€ Git ä¸­æ·»åŠ æ›´å¤šå…§å®¹ä¸¦å–å›äº†ã€‚ä¹Ÿå¯ä»¥ç›´æ¥æ·»åŠ æª”æ¡ˆã€‚æ¯”æ–¹èªªå¯ä»¥å°ä¸€å€‹æª”é€²è¡Œç°¡å–®çš„ç‰ˆæœ¬æ§åˆ¶ã€‚é¦–å…ˆï¼Œå‰µå»ºä¸€å€‹æ–°æª”ï¼Œä¸¦æŠŠæª”æ¡ˆå…§å®¹å„²å­˜åˆ°è³‡æ–™åº«ä¸­ï¼š

	$ echo 'version 1' > test.txt
	$ git hash-object -w test.txt
	83baae61804e65cc73a7201a7252750c76066a30

æ¥è‘—å¾€è©²æª”ä¸­å¯«å…¥ä¸€äº›æ–°å…§å®¹ä¸¦å†æ¬¡ä¿å­˜ï¼š 

	$ echo 'version 2' > test.txt
	$ git hash-object -w test.txt
	1f7a7a472abf3dd9643fd615f6da379c4acb3e3a

è³‡æ–™åº«ä¸­å·²ç¶“å°‡æª”æ¡ˆçš„å…©å€‹æ–°ç‰ˆæœ¬é€£åŒä¸€é–‹å§‹çš„å…§å®¹ä¿å­˜ä¸‹ä¾†äº†ï¼š 

	$ find .git/objects -type f
	.git/objects/1f/7a7a472abf3dd9643fd615f6da379c4acb3e3a
	.git/objects/83/baae61804e65cc73a7201a7252750c76066a30
	.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4

å†å°‡æª”æ¡ˆä¿®å¾©åˆ°ç¬¬ä¸€å€‹ç‰ˆæœ¬ï¼š 

	$ git cat-file -p 83baae61804e65cc73a7201a7252750c76066a30 > test.txt
	$ cat test.txt
	version 1

æˆ–æ¢å¾©åˆ°ç¬¬äºŒå€‹ç‰ˆæœ¬ï¼š 

	$ git cat-file -p 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a > test.txt
	$ cat test.txt
	version 2

éœ€è¦è¨˜ä½çš„æ˜¯å¹¾å€‹ç‰ˆæœ¬çš„æª” SHA-1 å€¼å¯èƒ½èˆ‡å¯¦éš›çš„å€¼ä¸åŒï¼Œå…¶æ¬¡ï¼Œå„²å­˜çš„ä¸¦ä¸æ˜¯æª”æ¡ˆåè€Œåƒ…åƒ…æ˜¯æª”æ¡ˆå…§å®¹ã€‚é€™ç¨®ç‰©ä»¶é¡å‹ç¨±ç‚º blob ã€‚é€šéå‚³é SHA-1 å€¼çµ¦ `cat-file -t` å‘½ä»¤å¯ä»¥è®“ Git è¿”å›ä»»ä½•ç‰©ä»¶çš„é¡å‹ï¼š 

	$ git cat-file -t 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a
	blob

## Tree ç‰©ä»¶

æ¥ä¸‹å»ä¾†çœ‹ tree ç‰©ä»¶ï¼Œtree ç‰©ä»¶å¯ä»¥å„²å­˜æª”æ¡ˆåï¼ŒåŒæ™‚ä¹Ÿå…è¨±å°‡ä¸€çµ„æª”æ¡ˆå„²å­˜åœ¨ä¸€èµ·ã€‚Git ä»¥ä¸€ç¨®é¡ä¼¼ UNIX æª”æ¡ˆç³»çµ±ä½†æ›´ç°¡å–®çš„æ–¹å¼ä¾†å„²å­˜å…§å®¹ã€‚æ‰€æœ‰å…§å®¹ä»¥ tree æˆ– blob ç‰©ä»¶å„²å­˜ï¼Œå…¶ä¸­ tree ç‰©ä»¶å°æ‡‰æ–¼ UNIX ä¸­çš„ç›®éŒ„ï¼Œblob ç‰©ä»¶å‰‡å¤§è‡´å°æ‡‰æ–¼ inodes æˆ–æª”æ¡ˆå…§å®¹ã€‚ä¸€å€‹å–®ç¨çš„ tree ç‰©ä»¶åŒ…å«ä¸€æ¢æˆ–å¤šæ¢ tree è¨˜éŒ„ï¼Œæ¯ä¸€æ¢è¨˜éŒ„å«æœ‰ä¸€å€‹æŒ‡å‘ blob æˆ–å­ tree ç‰©ä»¶çš„ SHA-1 æŒ‡æ¨™ï¼Œä¸¦é™„æœ‰è©²ç‰©ä»¶çš„è¨±å¯æ¬Šæ¨¡å¼ (mode)ã€é¡å‹å’Œæª”æ¡ˆåè³‡è¨Šã€‚ä»¥ simplegit å°ˆæ¡ˆç‚ºä¾‹ï¼Œæœ€æ–°çš„ tree å¯èƒ½æ˜¯é€™å€‹æ¨£å­ï¼š 

	$ git cat-file -p master^{tree}
	100644 blob a906cb2a4a904a152e80877d4088654daad0c859      README
	100644 blob 8f94139338f9404f26296befa88755fc2598c289      Rakefile
	040000 tree 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0      lib

`master^{tree}` è¡¨ç¤º `master` åˆ†æ”¯ä¸Šæœ€æ–°æäº¤æŒ‡å‘çš„ tree ç‰©ä»¶ã€‚è«‹æ³¨æ„ `lib` å­ç›®éŒ„ä¸¦éä¸€å€‹ blob ç‰©ä»¶ï¼Œè€Œæ˜¯ä¸€å€‹æŒ‡å‘åˆ¥ä¸€å€‹ tree ç‰©ä»¶çš„æŒ‡æ¨™ï¼š 

	$ git cat-file -p 99f1a6d12cb4b6f19c8655fca46c3ecf317074e0
	100644 blob 47c6340d6459e05787f644c2447d2595f5d3a54b      simplegit.rb

å¾æ¦‚å¿µä¸Šä¾†è¬›ï¼ŒGit ä¿å­˜çš„è³‡æ–™å¦‚åœ– 9-1 æ‰€ç¤ºã€‚ 


![](http://git-scm.com/figures/18333fig0901-tn.png)

Figure 9-1. Git ç‰©ä»¶æ¨¡å‹çš„ç°¡åŒ–ç‰ˆ

ä½ å¯ä»¥è‡ªå·±å‰µå»º tree ã€‚é€šå¸¸ Git æ ¹æ“šä½ çš„æš«å­˜å€åŸŸæˆ– index ä¾†å‰µå»ºä¸¦å¯«å…¥ä¸€å€‹ tree ã€‚å› æ­¤è¦å‰µå»ºä¸€å€‹ tree ç‰©ä»¶çš„è©±é¦–å…ˆè¦é€šéå°‡ä¸€äº›æª”æš«å­˜å¾è€Œå‰µå»ºä¸€å€‹ index ã€‚å¯ä»¥ä½¿ç”¨ plumbing å‘½ä»¤ `update-index` ç‚ºä¸€å€‹å–®ç¨æª” â”€â”€ test.txt æª”çš„ç¬¬ä¸€å€‹ç‰ˆæœ¬ â”€â”€ã€€å‰µå»ºä¸€å€‹ indexã€‚é€šéè©²å‘½ä»¤äººå·¥åœ°å°‡ test.txt æª”çš„é¦–å€‹ç‰ˆæœ¬åŠ å…¥åˆ°äº†ä¸€å€‹æ–°çš„æš«å­˜å€åŸŸä¸­ã€‚ç”±æ–¼è©²æª”åŸå…ˆä¸¦ä¸åœ¨æš«å­˜å€åŸŸä¸­ (ç”šè‡³å°±é€£æš«å­˜å€åŸŸä¹Ÿé‚„æ²’è¢«å‰µå»ºå‡ºä¾†å‘¢)ï¼Œå¿…é ˆå‚³å…¥ `--add` åƒæ•¸ï¼›ç”±æ–¼è¦æ·»åŠ çš„æª”ä¸¦ä¸åœ¨ç›®å‰çš„ç›®éŒ„ä¸‹è€Œæ˜¯åœ¨è³‡æ–™åº«ä¸­ï¼Œå¿…é ˆå‚³å…¥ `--cacheinfo` åƒæ•¸ã€‚åŒæ™‚æŒ‡å®šæª”æ¡ˆæ¨¡å¼ï¼ŒSHA-1 å€¼å’Œæª”æ¡ˆåï¼š

	$ git update-index --add --cacheinfo 100644 \
	  83baae61804e65cc73a7201a7252750c76066a30 test.txt

åœ¨æœ¬ä¾‹ä¸­ï¼ŒæŒ‡å®šäº†æª”æ¡ˆæ¨¡å¼ç‚º `100644`ï¼Œè¡¨æ˜é€™æ˜¯ä¸€å€‹æ™®é€šæª”ã€‚å…¶ä»–å¯ç”¨çš„æ¨¡å¼æœ‰ï¼š`100755` è¡¨ç¤ºå¯åŸ·è¡Œæª”ï¼Œ`120000` è¡¨ç¤ºç¬¦è™Ÿé€£çµ(symbolic link)ã€‚æª”æ¡ˆæ¨¡å¼æ˜¯å¾ä¸€èˆ¬çš„ UNIX æª”æ¡ˆæ¨¡å¼ä¸­åƒè€ƒä¾†çš„ï¼Œä½†æ˜¯æ²’æœ‰é‚£éº¼éˆæ´» â”€â”€ ä¸Šè¿°ä¸‰ç¨®æ¨¡å¼åƒ…å° Git ä¸­çš„æª”æ¡ˆ (blobs) æœ‰æ•ˆ (é›–ç„¶ä¹Ÿæœ‰å…¶ä»–æ¨¡å¼ç”¨æ–¼ç›®éŒ„å’Œå­æ¨¡çµ„)ã€‚ 

ç¾åœ¨å¯ä»¥ç”¨ `write-tree` å‘½ä»¤å°‡æš«å­˜å€åŸŸçš„å…§å®¹å¯«åˆ°ä¸€å€‹ tree ç‰©ä»¶äº†ã€‚ç„¡éœ€ `-w` åƒæ•¸ â”€â”€ å¦‚æœç›®æ¨™ tree ä¸å­˜åœ¨ï¼Œå‘¼å« `write-tree` æœƒè‡ªå‹•æ ¹æ“š index ç‹€æ…‹å‰µå»ºä¸€å€‹ tree ç‰©ä»¶ã€‚ 

	$ git write-tree
	d8329fc1cc938780ffdd9f94e0d364e0ea74f579
	$ git cat-file -p d8329fc1cc938780ffdd9f94e0d364e0ea74f579
	100644 blob 83baae61804e65cc73a7201a7252750c76066a30      test.txt

å¯ä»¥é©—è­‰é€™ç¢ºå¯¦æ˜¯ä¸€å€‹ tree ç‰©ä»¶ï¼š 

	$ git cat-file -t d8329fc1cc938780ffdd9f94e0d364e0ea74f579
	tree

å†æ ¹æ“š test.txt çš„ç¬¬äºŒå€‹ç‰ˆæœ¬ä»¥åŠä¸€å€‹æ–°æª”å‰µå»ºä¸€å€‹æ–° tree ç‰©ä»¶ï¼š 

	$ echo 'new file' > new.txt
	$ git update-index test.txt
	$ git update-index --add new.txt

é€™æ™‚æš«å­˜å€åŸŸä¸­åŒ…å«äº† test.txt çš„æ–°ç‰ˆæœ¬åŠä¸€å€‹æ–°æª” new.txt ã€‚å‰µå»º (å¯«) è©² tree ç‰©ä»¶ (å°‡æš«å­˜å€åŸŸæˆ– index ç‹€æ…‹å¯«å…¥åˆ°ä¸€å€‹ tree ç‰©ä»¶)ï¼Œç„¶å¾Œç§ç§å®ƒçš„æ¨£å­ï¼š 

	$ git write-tree
	0155eb4229851634a0f03eb265b69f5a2d56f341
	$ git cat-file -p 0155eb4229851634a0f03eb265b69f5a2d56f341
	100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
	100644 blob 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a      test.txt

è«‹æ³¨æ„è©² tree ç‰©ä»¶åŒ…å«äº†å…©å€‹æª”æ¡ˆè¨˜éŒ„ï¼Œä¸” test.txt çš„ SHA å€¼æ˜¯æ—©å…ˆå€¼çš„ â€œç¬¬äºŒç‰ˆâ€ (`1f7a7a`)ã€‚ä¾†é»æ›´æœ‰è¶£çš„ï¼Œä½ å°‡æŠŠç¬¬ä¸€å€‹ tree ç‰©ä»¶ä½œç‚ºä¸€å€‹å­ç›®éŒ„åŠ é€²è©² tree ä¸­ã€‚å¯ä»¥ç”¨ `read-tree` å‘½ä»¤å°‡ tree ç‰©ä»¶è®€åˆ°æš«å­˜å€åŸŸä¸­å»ã€‚åœ¨é€™æ™‚ï¼Œé€šéå‚³ä¸€å€‹ `--prefix` åƒæ•¸çµ¦ `read-tree`ï¼Œå°‡ä¸€å€‹å·²æœ‰çš„ tree ç‰©ä»¶ä½œç‚ºä¸€å€‹å­ tree è®€åˆ°æš«å­˜å€åŸŸä¸­ï¼š 

	$ git read-tree --prefix=bak d8329fc1cc938780ffdd9f94e0d364e0ea74f579
	$ git write-tree
	3c4e9cd789d88d8d89c1073707c3585e41b0e614
	$ git cat-file -p 3c4e9cd789d88d8d89c1073707c3585e41b0e614
	040000 tree d8329fc1cc938780ffdd9f94e0d364e0ea74f579      bak
	100644 blob fa49b077972391ad58037050f2a75f74e3671e92      new.txt
	100644 blob 1f7a7a472abf3dd9643fd615f6da379c4acb3e3a      test.txt

å¦‚æœå¾å‰›å¯«å…¥çš„æ–° tree ç‰©ä»¶å‰µå»ºä¸€å€‹å·¥ä½œç›®éŒ„ï¼Œå°‡å¾—åˆ°ä½æ–¼å·¥ä½œç›®éŒ„é ‚ç´šçš„å…©å€‹æª”å’Œä¸€å€‹åç‚º `bak` çš„å­ç›®éŒ„ï¼Œè©²å­ç›®éŒ„åŒ…å«äº† test.txt æª”çš„ç¬¬ä¸€å€‹ç‰ˆæœ¬ã€‚å¯ä»¥å°‡ Git ç”¨ä¾†åŒ…å«é€™äº›å…§å®¹çš„è³‡æ–™æƒ³åƒæˆå¦‚åœ– 9-2 æ‰€ç¤ºçš„æ¨£å­ã€‚ 


![](http://git-scm.com/figures/18333fig0902-tn.png)

Figure 9-2. ç•¶å‰ Git è³‡æ–™çš„å…§å®¹çµæ§‹ 

## Commit ç‰©ä»¶

ä½ ç¾åœ¨æœ‰ä¸‰å€‹ tree ç‰©ä»¶ï¼Œå®ƒå€‘æŒ‡å‘äº†ä½ è¦è·Ÿè¹¤çš„å°ˆæ¡ˆçš„ä¸åŒå¿«ç…§ï¼Œå¯æ˜¯å…ˆå‰çš„å•é¡Œä¾ç„¶å­˜åœ¨ï¼šå¿…é ˆè¨˜å¾€ä¸‰å€‹ SHA-1 å€¼ä»¥ç²å¾—é€™äº›å¿«ç…§ã€‚ä½ ä¹Ÿæ²’æœ‰é—œæ–¼èª°ã€ä½•æ™‚ä»¥åŠç‚ºä½•ä¿å­˜äº†é€™äº›å¿«ç…§çš„è³‡è¨Šã€‚commit ç‰©ä»¶ç‚ºä½ ä¿å­˜äº†é€™äº›åŸºæœ¬è³‡è¨Šã€‚ 

è¦å‰µå»ºä¸€å€‹ commit ç‰©ä»¶ï¼Œä½¿ç”¨ `commit-tree` å‘½ä»¤ï¼ŒæŒ‡å®šä¸€å€‹ tree çš„ SHA-1ï¼Œå¦‚æœæœ‰ä»»ä½•å‰ç¹¼æäº¤ç‰©ä»¶ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šã€‚å¾ä½ å¯«çš„ç¬¬ä¸€å€‹ tree é–‹å§‹ï¼š 

	$ echo 'first commit' | git commit-tree d8329f
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d

é€šé `cat-file` æŸ¥çœ‹é€™å€‹æ–° commit ç‰©ä»¶ï¼š 

	$ git cat-file -p fdf4fc3
	tree d8329fc1cc938780ffdd9f94e0d364e0ea74f579
	author Scott Chacon <schacon@gmail.com> 1243040974 -0700
	committer Scott Chacon <schacon@gmail.com> 1243040974 -0700

	first commit

commit ç‰©ä»¶æ ¼å¼å¾ˆç°¡å–®ï¼šæŒ‡æ˜äº†è©²æ™‚é–“é»å°ˆæ¡ˆå¿«ç…§çš„é ‚å±¤æ¨¹ç‰©ä»¶ã€ä½œè€…/æäº¤è€…è³‡è¨Š (å¾ Git çµ„æ…‹è¨­å®šçš„ `user.name` å’Œ `user.email` ä¸­ç²å¾—) ä»¥åŠç•¶å‰æ™‚é–“æˆ³è¨˜ã€ä¸€å€‹ç©ºè¡Œï¼Œä»¥åŠæäº¤æ³¨é‡‹è³‡è¨Šã€‚

æ¥è‘—å†å¯«å…¥å¦å¤–å…©å€‹ commit ç‰©ä»¶ï¼Œæ¯ä¸€å€‹éƒ½æŒ‡å®šå…¶ä¹‹å‰çš„é‚£å€‹ commit ç‰©ä»¶ï¼š 

	$ echo 'second commit' | git commit-tree 0155eb -p fdf4fc3
	cac0cab538b970a37ea1e769cbbde608743bc96d
	$ echo 'third commit'  | git commit-tree 3c4e9c -p cac0cab
	1a410efbd13591db07496601ebc7a059dd55cfe9

æ¯ä¸€å€‹ commit ç‰©ä»¶éƒ½æŒ‡å‘äº†ä½ å‰µå»ºçš„æ¨¹ç‰©ä»¶å¿«ç…§ã€‚å‡ºä¹æ„æ–™çš„æ˜¯ï¼Œç¾åœ¨å·²ç¶“æœ‰äº†çœŸå¯¦çš„ Git æ­·å²äº†ï¼Œæ‰€ä»¥å¦‚æœåŸ·è¡Œ `git log` å‘½ä»¤ä¸¦æŒ‡å®šæœ€å¾Œé‚£å€‹ commit ç‰©ä»¶çš„ SHA-1 ä¾¿å¯ä»¥æŸ¥çœ‹æ­·å²ï¼š

	$ git log --stat 1a410e
	commit 1a410efbd13591db07496601ebc7a059dd55cfe9
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:15:24 2009 -0700

	    third commit

	 bak/test.txt |    1 +
	 1 files changed, 1 insertions(+), 0 deletions(-)

	commit cac0cab538b970a37ea1e769cbbde608743bc96d
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:14:29 2009 -0700

	    second commit

	 new.txt  |    1 +
	 test.txt |    2 +-
	 2 files changed, 2 insertions(+), 1 deletions(-)

	commit fdf4fc3344e67ab068f836878b6c4951e3b15f3d
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:09:34 2009 -0700

	    first commit

	 test.txt |    1 +
	 1 files changed, 1 insertions(+), 0 deletions(-)

çœŸæ£’ã€‚ä½ å‰›å‰›é€šéä½¿ç”¨ä½ç´šæ“ä½œè€Œä¸æ˜¯é‚£äº›æ™®é€šå‘½ä»¤å‰µå»ºäº†ä¸€å€‹ Git æ­·å²ã€‚é€™åŸºæœ¬ä¸Šå°±æ˜¯åŸ·è¡Œ `git add` å’Œ `git commit` å‘½ä»¤æ™‚ Git é€²è¡Œçš„å·¥ä½œã€€â”€â”€ä¿å­˜ä¿®æ”¹äº†çš„æª”æ¡ˆçš„ blobï¼Œæ›´æ–°ç´¢å¼•ï¼Œå‰µå»º tree ç‰©ä»¶ï¼Œæœ€å¾Œå‰µå»º commit ç‰©ä»¶ï¼Œé€™äº› commit ç‰©ä»¶æŒ‡å‘äº†é ‚å±¤ tree ç‰©ä»¶ä»¥åŠå…ˆå‰çš„ commit ç‰©ä»¶ã€‚é€™ä¸‰é¡ Git ç‰©ä»¶ â”€â”€ blobï¼Œtree ä»¥åŠ commit â”€â”€ éƒ½å„è‡ªä»¥æª”æ¡ˆçš„æ–¹å¼ä¿å­˜åœ¨ `.git/objects` ç›®éŒ„ä¸‹ã€‚ä»¥ä¸‹æ‰€åˆ—æ˜¯ç›®å‰ç‚ºæ­¢ç¯„ä¾‹ç›®éŒ„çš„æ‰€æœ‰ç‰©ä»¶ï¼Œæ¯å€‹ç‰©ä»¶å¾Œé¢çš„æ³¨é‡‹è£¡æ¨™æ˜äº†å®ƒå€‘ä¿å­˜çš„å…§å®¹ï¼š 

	$ find .git/objects -type f
	.git/objects/01/55eb4229851634a0f03eb265b69f5a2d56f341 # tree 2
	.git/objects/1a/410efbd13591db07496601ebc7a059dd55cfe9 # commit 3
	.git/objects/1f/7a7a472abf3dd9643fd615f6da379c4acb3e3a # test.txt v2
	.git/objects/3c/4e9cd789d88d8d89c1073707c3585e41b0e614 # tree 3
	.git/objects/83/baae61804e65cc73a7201a7252750c76066a30 # test.txt v1
	.git/objects/ca/c0cab538b970a37ea1e769cbbde608743bc96d # commit 2
	.git/objects/d6/70460b4b4aece5915caf5c68d12f560a9fe3e4 # 'test content'
	.git/objects/d8/329fc1cc938780ffdd9f94e0d364e0ea74f579 # tree 1
	.git/objects/fa/49b077972391ad58037050f2a75f74e3671e92 # new.txt
	.git/objects/fd/f4fc3344e67ab068f836878b6c4951e3b15f3d # commit 1

å¦‚æœä½ æŒ‰ç…§ä»¥ä¸Šæè¿°é€²è¡Œäº†æ“ä½œï¼Œå¯ä»¥å¾—åˆ°å¦‚åœ– 9-3 æ‰€ç¤ºçš„ç‰©ä»¶åœ–ã€‚ 


![](http://git-scm.com/figures/18333fig0903-tn.png)

Figure 9-3. Git ç›®éŒ„ä¸‹çš„æ‰€æœ‰ç‰©ä»¶

## ç‰©ä»¶å„²å­˜

ä¹‹å‰æˆ‘æåˆ°ç•¶å„²å­˜è³‡æ–™å…§å®¹æ™‚ï¼ŒåŒæ™‚æœƒæœ‰ä¸€å€‹æª”é ­è¢«å„²å­˜èµ·ä¾†ã€‚æˆ‘å€‘èŠ±äº›æ™‚é–“ä¾†çœ‹çœ‹ Git æ˜¯å¦‚ä½•å„²å­˜ç‰©ä»¶çš„ã€‚ä½ å°‡çœ‹åˆ°å¦‚ä½•é€šé Ruby æŒ‡ä»¤ç¢¼èªè¨€å„²å­˜ä¸€å€‹ blob ç‰©ä»¶ (é€™è£¡ä»¥å­—ä¸² â€œwhat is up, doc?â€ ç‚ºä¾‹) ã€‚ä½¿ç”¨ `irb` å‘½ä»¤é€²å…¥ Ruby äº’å‹•å¼æ¨¡å¼ï¼š 

	$ irb
	>> content = "what is up, doc?"
	=> "what is up, doc?"

Git ä»¥ç‰©ä»¶é¡å‹ç‚ºèµ·å§‹å…§å®¹æ§‹é€ ä¸€å€‹æª”é ­ï¼Œæœ¬ä¾‹ä¸­æ˜¯ä¸€å€‹ blobã€‚ç„¶å¾Œæ·»åŠ ä¸€å€‹ç©ºæ ¼ï¼Œæ¥è‘—æ˜¯è³‡æ–™å…§å®¹çš„é•·åº¦ï¼Œæœ€å¾Œæ˜¯ä¸€å€‹ç©ºä½å…ƒçµ„ (null byte)ï¼š 

	>> header = "blob #{content.length}\0"
	=> "blob 16\000"

Git å°‡æª”é ­èˆ‡åŸå§‹è³‡æ–™å…§å®¹æ‹¼æ¥èµ·ä¾†ï¼Œä¸¦è¨ˆç®—æ‹¼æ¥å¾Œçš„æ–°å…§å®¹çš„ SHA-1 æ ¡é©—å’Œã€‚å¯ä»¥åœ¨ Ruby ä¸­ä½¿ç”¨ `require` èªå¥å°å…¥ SHA1 digest ç¨‹å¼åº«ï¼Œç„¶å¾Œå‘¼å« `Digest::SHA1.hexdigest()` æ–¹æ³•è¨ˆç®—å­—ä¸²çš„ SHA-1 å€¼ï¼š 

	>> store = header + content
	=> "blob 16\000what is up, doc?"
	>> require 'digest/sha1'
	=> true
	>> sha1 = Digest::SHA1.hexdigest(store)
	=> "bd9dbf5aae1a3862dd1526723246b20206e5fc37"

Git ç”¨ zlib å°è³‡æ–™å…§å®¹é€²è¡Œå£“ç¸®ï¼Œåœ¨ Ruby ä¸­å¯ä»¥ç”¨ zlib ç¨‹å¼åº«ä¾†å¯¦ç¾ã€‚é¦–å…ˆéœ€è¦å°å…¥è©²ç¨‹å¼åº«ï¼Œç„¶å¾Œç”¨ `Zlib::Deflate.deflate()` å°è³‡æ–™é€²è¡Œå£“ç¸®ï¼š 

	>> require 'zlib'
	=> true
	>> zlib_content = Zlib::Deflate.deflate(store)
	=> "x\234K\312\311OR04c(\317H,Q\310,V(-\320QH\311O\266\a\000_\034\a\235"

æœ€å¾Œå°‡ç”¨ zlib å£“ç¸®å¾Œçš„å…§å®¹å¯«å…¥ç£ç‰‡ã€‚éœ€è¦æŒ‡å®šä¿å­˜ç‰©ä»¶çš„è·¯å¾‘ (SHA-1 å€¼çš„é ­å…©å€‹å­—å…ƒä½œç‚ºå­ç›®éŒ„åç¨±ï¼Œå‰©é¤˜ 38 å€‹å­—å…ƒä½œç‚ºæª”æ¡ˆåä¿å­˜è‡³è©²å­ç›®éŒ„ä¸­)ã€‚åœ¨ Ruby ä¸­ï¼Œå¦‚æœå­ç›®éŒ„ä¸å­˜åœ¨å¯ä»¥ç”¨ `FileUtils.mkdir_p()` å‡½æ•¸å‰µå»ºå®ƒã€‚æ¥è‘—ç”¨ `File.open` æ–¹æ³•æ‰“é–‹æª”æ¡ˆï¼Œä¸¦ç”¨ `write()` æ–¹æ³•å°‡ä¹‹å‰å£“ç¸®çš„å…§å®¹å¯«å…¥è©²æª”ï¼š 

	>> path = '.git/objects/' + sha1[0,2] + '/' + sha1[2,38]
	=> ".git/objects/bd/9dbf5aae1a3862dd1526723246b20206e5fc37"
	>> require 'fileutils'
	=> true
	>> FileUtils.mkdir_p(File.dirname(path))
	=> ".git/objects/bd"
	>> File.open(path, 'w') { |f| f.write zlib_content }
	=> 32

é€™å°±è¡Œäº† â”€â”€ ä½ å·²ç¶“å‰µå»ºäº†ä¸€å€‹æ­£ç¢ºçš„ blob ç‰©ä»¶ã€‚æ‰€æœ‰çš„ Git ç‰©ä»¶éƒ½ä»¥é€™ç¨®æ–¹å¼å„²å­˜ï¼ŒæƒŸä¸€çš„å€åˆ¥æ˜¯é¡å‹ä¸åŒ â”€â”€ é™¤äº†å­—ä¸² blobï¼Œæª”é ­èµ·å§‹å…§å®¹é‚„å¯ä»¥æ˜¯ commit æˆ– tree ã€‚ä¸éé›–ç„¶ blob å¹¾ä¹å¯ä»¥æ˜¯ä»»æ„å…§å®¹ï¼Œcommit å’Œ tree çš„è³‡æ–™å»æ˜¯æœ‰å›ºå®šæ ¼å¼çš„ã€‚ 
¸‹ä¾†æˆ‘å€‘è¦ä¿è­‰æ²’æœ‰ä¿®æ”¹åˆ° ACL å…è¨±ç¯„åœä¹‹å¤–çš„æª”æ¡ˆã€‚å¦‚æœä½ çš„å°ˆæ¡ˆ `.git` ç›®éŒ„è£¡æœ‰å‰é¢ä½¿ç”¨éçš„ ACL æª”ï¼Œé‚£éº¼ä»¥ä¸‹çš„ `pre-commit` è…³æœ¬å°‡åŸ·è¡Œè£¡é¢çš„é™åˆ¶è¦å®šï¼š

	#!/usr/bin/env ruby

	$user    = ENV['USER']

	# [ insert acl_access_data method from above ]

	# only allows certain users to modify certain subdirectories in a project
	def check_directory_perms
	  access = get_acl_access_data('.git/acl')

	  files_modified = `git diff-index --cached --name-only HEAD`.split("\n")
	  files_modified.each do |path|
	    next if path.size == 0
	    has_file_access = false
	    access[$user].each do |access_path|
	    if !access_path || (path.index(access_path) == 0)
	      has_file_access = true
	    end
	    if !has_file_access
	      puts "[POLICY] You do not have access to push to #{path}"
	      exit 1
	    end
	  end
	end

	check_directory_perms

é€™å’Œæœå‹™ç«¯çš„è…³æœ¬å¹¾ä¹ä¸€æ¨£ï¼Œé™¤äº†å…©å€‹é‡è¦å€åˆ¥ã€‚ç¬¬ä¸€ï¼ŒACL æª”çš„ä½ç½®ä¸åŒï¼Œå› ç‚ºé€™å€‹è…³æœ¬åœ¨ç•¶å‰å·¥ä½œç›®éŒ„åŸ·è¡Œï¼Œè€Œé Git ç›®éŒ„ã€‚ACL æª”çš„ç›®éŒ„å¿…é ˆç”±é€™å€‹

	access = get_acl_access_data('acl')

æ”¹æˆé€™å€‹:

	access = get_acl_access_data('.git/acl')

å¦ä¸€å€‹é‡è¦å€åˆ¥æ˜¯ç²å–ã€Œè¢«ä¿®æ”¹æª”æ¡ˆæ¸…å–®ã€çš„æ–¹å¼ã€‚åœ¨æœå‹™ç«¯çš„æ™‚å€™ä½¿ç”¨äº†æŸ¥çœ‹æäº¤ç´€éŒ„çš„æ–¹å¼ï¼Œå¯æ˜¯ç›®å‰çš„æäº¤éƒ½é‚„æ²’è¢«è¨˜éŒ„ä¸‹ä¾†å‘¢ï¼Œæ‰€ä»¥é€™å€‹æ¸…å–®åªèƒ½å¾æš«å­˜å€åŸŸç²å–ã€‚åŸä¾†æ˜¯é€™æ¨£ï¼š

	files_modified = `git log -1 --name-only --pretty=format:'' #{ref}`

ç¾åœ¨è¦ç”¨é€™æ¨£ï¼š

	files_modified = `git diff-index --cached --name-only HEAD`

ä¸åŒçš„å°±åªæœ‰é€™å…©é»â€”â€”é™¤æ­¤ä¹‹å¤–ï¼Œè©²è…³æœ¬å®Œå…¨ç›¸åŒã€‚ä¸€å€‹å°é™·é˜±åœ¨æ–¼å®ƒå‡è¨­åœ¨æœ¬åœ°åŸ·è¡Œçš„å¸³æˆ¶å’Œæ¨é€åˆ°é ç«¯æœå‹™ç«¯çš„ç›¸åŒã€‚å¦‚æœé€™äºŒè€…ä¸ä¸€æ¨£ï¼Œå‰‡éœ€è¦æ‰‹å‹•è¨­ç½®ä¸€ä¸‹ `$user` è®Šæ•¸ã€‚

æœ€å¾Œä¸€é …ä»»å‹™æ˜¯æª¢æŸ¥ç¢ºèªæ¨é€å…§å®¹ä¸­ä¸åŒ…å«é fast-forward é¡å‹çš„ç´¢å¼•(reference)ï¼Œä¸éé€™å€‹éœ€æ±‚æ¯”è¼ƒå°‘è¦‹ã€‚ä»¥ä¸‹æƒ…æ³æœƒå¾—åˆ°ä¸€å€‹é fast-forward é¡å‹çš„ç´¢å¼•ï¼Œè¦éº¼åœ¨æŸå€‹å·²ç¶“æ¨é€éçš„æäº¤ä¸Šåšè¡åˆï¼Œè¦éº¼å¾æœ¬åœ°ä¸åŒåˆ†æ”¯æ¨é€åˆ°é ç«¯ç›¸åŒçš„åˆ†æ”¯ä¸Šã€‚

æ—¢ç„¶ä¼ºæœå™¨æœƒå‘Šè¨´ä½ ä¸èƒ½æ¨é€é fast-forward å…§å®¹ï¼Œè€Œä¸”ä¸Šé¢çš„æ›é‰¤ä¹Ÿèƒ½é˜»æ­¢å¼·åˆ¶çš„æ¨é€ï¼Œå”¯ä¸€å‰©ä¸‹çš„æ½›åœ¨å•é¡Œå°±æ˜¯è¡åˆå·²ç¶“æ¨é€éçš„æäº¤å…§å®¹ã€‚

ä¸‹é¢æ˜¯ä¸€å€‹æª¢æŸ¥é€™å€‹å•é¡Œçš„ pre-rabase è…³æœ¬çš„ä¾‹å­ã€‚å®ƒç²å–ä¸€å€‹æ‰€æœ‰å³å°‡é‡å¯«çš„æäº¤å…§å®¹çš„æ¸…å–®ï¼Œç„¶å¾Œæª¢æŸ¥å®ƒå€‘æ˜¯å¦åœ¨é ç«¯çš„ç´¢å¼•(reference)è£¡å·²ç¶“å­˜åœ¨ã€‚ä¸€æ—¦ç™¼ç¾æŸå€‹æäº¤å¯ä»¥å¾é ç«¯ç´¢å¼•è£¡è¡è®Šéä¾†ï¼Œå®ƒå°±æ”¾æ£„è¡åˆæ“ä½œï¼š

	#!/usr/bin/env ruby

	base_branch = ARGV[0]
	if ARGV[1]
	  topic_branch = ARGV[1]
	else
	  topic_branch = "HEAD"
	end

	target_shas = `git rev-list #{base_branch}..#{topic_branch}`.split("\n")
	remote_refs = `git branch -r`.split("\n").map { |r| r.strip }

	target_shas.each do |sha|
	  remote_refs.each do |remote_ref|
	    shas_pushed = `git rev-list ^#{sha}^@ refs/remotes/#{remote_ref}`
	    if shas_pushed.split("\n").include?(sha)
	      puts "[POLICY] Commit #{sha} has already been pushed to #{remote_ref}"
	      exit 1
	    end
	  end
	end

é€™å€‹è…³æœ¬åˆ©ç”¨äº†ä¸€å€‹ç¬¬å…­ç« ã€Œä¿®è¨‚ç‰ˆæœ¬é¸æ“‡ã€ä¸€ç¯€ä¸­ä¸æ›¾æåˆ°çš„èªæ³•ã€‚åŸ·è¡Œé€™å€‹å‘½ä»¤å¯ä»¥ç²å¾—ä¸€å€‹æ‰€æœ‰å·²ç¶“å®Œæˆæ¨é€çš„æäº¤çš„åˆ—è¡¨ï¼š

	git rev-list ^#{sha}^@ refs/remotes/#{remote_ref}

`SHA^@` èªæ³•è§£æè©²æ¬¡æäº¤çš„æ‰€æœ‰ç¥–å…ˆã€‚æˆ‘å€‘å°‹æ‰¾ä»»ä½•ä¸€å€‹æäº¤ï¼Œé€™å€‹æäº¤å¯ä»¥å¾é ç«¯æœ€å¾Œä¸€æ¬¡æäº¤è¡è®Šç²å¾—(reachable)ï¼Œä½†å¾æˆ‘å€‘å˜—è©¦æ¨é€çš„ä»»ä½•ä¸€å€‹æäº¤çš„ SHA å€¼çš„ä»»ä½•ä¸€å€‹ç¥–å…ˆéƒ½ç„¡æ³•è¡è®Šç²å¾—â€”â€”ä¹Ÿå°±æ˜¯ fast-forward çš„å…§å®¹ã€‚

é€™å€‹è§£æ±ºæ–¹æ¡ˆçš„ç¼ºé»åœ¨æ–¼å®ƒå¯èƒ½æœƒå¾ˆæ…¢è€Œä¸”é€šå¸¸æ˜¯æ²’æœ‰å¿…è¦çš„â€”â€”åªè¦ä¸ç”¨ -f ä¾†å¼·åˆ¶æ¨é€ï¼Œä¼ºæœå™¨æœƒè‡ªå‹•çµ¦å‡ºè­¦å‘Šä¸¦ä¸”æ‹’çµ•æ¨é€å…§å®¹ã€‚ç„¶è€Œï¼Œé€™æ˜¯å€‹ä¸éŒ¯çš„ç·´ç¿’ï¼Œè€Œä¸”ç†è«–ä¸Šèƒ½å¹«åŠ©ç”¨æˆ¶é¿å…ä¸€å€‹å°‡ä¾†ä¸å¾—ä¸å›é ­ä¿®æ”¹çš„è¡åˆæ“ä½œã€‚
