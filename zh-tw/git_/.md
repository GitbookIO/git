# ç¸½çµ

ç¾åœ¨ä½ æ‡‰è©²å° Git å¯ä»¥ä½œä»€éº¼ç›¸ç•¶ç­è§£äº†ï¼Œä¸¦ä¸”åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¹ŸçŸ¥é“äº† Git æ˜¯å¦‚ä½•å¯¦ç¾çš„ã€‚æœ¬ç« æ¶µè“‹äº†è¨±å¤š plumbing å‘½ä»¤ â”€â”€ é€™äº›å‘½ä»¤æ¯”è¼ƒåº•å±¤ï¼Œä¸”æ¯”ä½ åœ¨æœ¬æ›¸å…¶ä»–éƒ¨åˆ†å­¸åˆ°çš„ porcelain å‘½ä»¤è¦ä¾†å¾—ç°¡å–®ã€‚å¾åº•å±¤ç­è§£ Git çš„å·¥ä½œåŸç†å¯ä»¥å¹«åŠ©ä½ æ›´å¥½åœ°ç†è§£ç‚ºä½• Git å¯¦ç¾äº†ç›®å‰çš„é€™äº›åŠŸèƒ½ï¼Œä¹Ÿä½¿ä½ èƒ½å¤ é‡å°ä½ çš„å·¥ä½œæµç¨‹å¯«å‡ºè‡ªå·±çš„å·¥å…·å’Œè…³æœ¬ã€‚

Git ä½œç‚ºä¸€å¥— content-addressable çš„æª”æ¡ˆç³»çµ±ï¼Œæ˜¯ä¸€å€‹éå¸¸å¼·å¤§çš„å·¥å…·ï¼Œè€Œä¸åƒ…åƒ…åªæ˜¯ä¸€å€‹ VCSã€‚å¸Œæœ›å€ŸåŠ©æ–¼ä½ æ–°å­¸åˆ°çš„ Git å…§éƒ¨åŸç†çš„çŸ¥è­˜ï¼Œä½ å¯ä»¥è‡ªå·±å¯¦åšå‡ºæœ‰è¶£çš„æ‡‰ç”¨ï¼Œä¸¦ä»¥æ›´é€²éšçš„æ–¹å¼ã€æ›´å¦‚é­šå¾—æ°´çš„ä½¿ç”¨ Gitã€‚ 
‹å‹•åŸ·è¡Œ auto gc å‘½ä»¤ï¼š 

	$ git gc --auto

å†æ¬¡å¼·èª¿ï¼Œé€™å€‹å‘½ä»¤ä¸€èˆ¬ä»€éº¼éƒ½ä¸å¹¹ã€‚å¦‚æœæœ‰ 7,000 å€‹å·¦å³çš„é¬†æ•£å°è±¡æˆ–æ˜¯ 50 å€‹ä»¥ä¸Šçš„ packfileï¼ŒGit æ‰æœƒçœŸæ­£è§¸ç™¼ gc å‘½ä»¤ã€‚ä½ å¯ä»¥ä¿®æ”¹é…ç½®ä¸­çš„ `gc.auto` å’Œ `gc.autopacklimit` ä¾†èª¿æ•´é€™å…©å€‹è¨­å®šå€¼ã€‚ 

`gc` é‚„æœƒå°‡æ‰€æœ‰å¼•ç”¨ (references) ä½µå…¥ä¸€å€‹å–®ç¨æª”ã€‚å‡è¨­å€‰åº«ä¸­åŒ…å«ä»¥ä¸‹åˆ†æ”¯å’Œæ¨™ç±¤ï¼š 

	$ find .git/refs -type f
	.git/refs/heads/experiment
	.git/refs/heads/master
	.git/refs/tags/v1.0
	.git/refs/tags/v1.1

é€™æ™‚å¦‚æœåŸ·è¡Œ `git gc`, `refs` ä¸‹çš„æ‰€æœ‰æª”éƒ½æœƒæ¶ˆå¤±ã€‚Git æœƒå°‡é€™äº›æª”æŒªåˆ° `.git/packed-refs` æª”ä¸­å»ä»¥æé«˜æ•ˆç‡ï¼Œè©²æª”æ˜¯é€™å€‹æ¨£å­çš„ï¼š 

	$ cat .git/packed-refs
	# pack-refs with: peeled
	cac0cab538b970a37ea1e769cbbde608743bc96d refs/heads/experiment
	ab1afef80fac8e34258ff41fc1b867c702daa24b refs/heads/master
	cac0cab538b970a37ea1e769cbbde608743bc96d refs/tags/v1.0
	9585191f37f7b0fb9444f35a9bf50de191beadc2 refs/tags/v1.1
	^1a410efbd13591db07496601ebc7a059dd55cfe9

ç•¶æ›´æ–°ä¸€å€‹å¼•ç”¨æ™‚ï¼ŒGit ä¸æœƒä¿®æ”¹é€™å€‹æª”ï¼Œè€Œæ˜¯åœ¨ `refs/heads` ä¸‹å¯«å…¥ä¸€å€‹æ–°æª”ã€‚ç•¶æŸ¥æ‰¾ä¸€å€‹å¼•ç”¨çš„ SHA æ™‚ï¼ŒGit é¦–å…ˆåœ¨ `refs` ç›®éŒ„ä¸‹æŸ¥æ‰¾ï¼Œå¦‚æœæœªæ‰¾åˆ°å‰‡åˆ° `packed-refs` æª”ä¸­å»æŸ¥æ‰¾ã€‚å› æ­¤å¦‚æœåœ¨ `refs` ç›®éŒ„ä¸‹æ‰¾ä¸åˆ°ä¸€å€‹å¼•ç”¨ï¼Œè©²å¼•ç”¨å¯èƒ½å­˜åˆ° `packed-refs` æª”ä¸­å»äº†ã€‚ 

è«‹ç•™æ„æª”æœ€å¾Œä»¥ `^` é–‹é ­çš„é‚£ä¸€è¡Œã€‚é€™è¡¨ç¤ºè©²è¡Œä¸Šä¸€è¡Œçš„é‚£å€‹æ¨™ç±¤æ˜¯ä¸€å€‹ annotated æ¨™ç±¤ï¼Œè€Œè©²è¡Œæ­£æ˜¯é‚£å€‹æ¨™ç±¤æ‰€æŒ‡å‘çš„ commit ã€‚

## è³‡æ–™å¾©åŸ

åœ¨ä½¿ç”¨ Git çš„éç¨‹ä¸­ï¼Œæœ‰æ™‚æœƒä¸å°å¿ƒä¸Ÿå¤± commit è³‡è¨Šã€‚é€™ä¸€èˆ¬å‡ºç¾åœ¨ä»¥ä¸‹æƒ…æ³ä¸‹ï¼šå¼·åˆ¶åˆªé™¤äº†ä¸€å€‹åˆ†æ”¯è€Œå¾Œåˆæƒ³é‡æ–°ä½¿ç”¨é€™å€‹åˆ†æ”¯ï¼Œhard-reset äº†ä¸€å€‹åˆ†æ”¯å¾è€Œä¸Ÿæ£„äº†åˆ†æ”¯çš„éƒ¨åˆ† commitã€‚å¦‚æœé€™çœŸçš„ç™¼ç”Ÿäº†ï¼Œæœ‰ä»€éº¼è¾¦æ³•æŠŠä¸Ÿå¤±çš„ commit æ‰¾å›ä¾†å‘¢ï¼Ÿ 

ä¸‹é¢çš„ä¾‹å­æ¼”ç¤ºäº†å° test å€‰åº« master åˆ†æ”¯é€²è¡Œ hard-reset åˆ°ä¸€å€‹è€ç‰ˆæœ¬çš„ commit çš„æ“ä½œï¼Œç„¶å¾Œæ¢å¾©ä¸Ÿå¤±çš„ commit ã€‚é¦–å…ˆæŸ¥çœ‹ä¸€ä¸‹ç•¶å‰çš„å€‰åº«ç‹€æ…‹ï¼š 

	$ git log --pretty=oneline
	ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
	484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

æ¥è‘—å°‡ `master` åˆ†æ”¯ç§»å›è‡³ä¸­é–“çš„ä¸€å€‹ commitï¼š 

	$ git reset --hard 1a410efbd13591db07496601ebc7a059dd55cfe9
	HEAD is now at 1a410ef third commit
	$ git log --pretty=oneline
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

é€™æ¨£å°±ä¸Ÿæ£„äº†æœ€æ–°çš„å…©å€‹ commit â”€â”€ åŒ…å«é€™å…©å€‹ commit çš„åˆ†æ”¯ä¸å­˜åœ¨äº†ã€‚ç¾åœ¨è¦åšçš„æ˜¯æ‰¾å‡ºæœ€æ–°çš„é‚£å€‹ commit çš„ SHAï¼Œç„¶å¾Œæ·»åŠ ä¸€å€‹æŒ‡å‘å®ƒçš„åˆ†æ”¯ã€‚é—œéµåœ¨æ–¼æ‰¾å‡ºæœ€æ–°çš„ commit çš„ SHA â”€â”€ ä½ ä¸å¤§å¯èƒ½è¨˜ä½äº†é€™å€‹ SHAï¼Œæ˜¯å§ï¼Ÿ 

é€šå¸¸æœ€å¿«æ·çš„è¾¦æ³•æ˜¯ä½¿ç”¨ `git reflog` å·¥å…·ã€‚ç•¶ä½  (åœ¨ä¸€å€‹å€‰åº«ä¸‹) å·¥ä½œæ™‚ï¼ŒGit æœƒåœ¨ä½ æ¯æ¬¡ä¿®æ”¹äº† HEAD æ™‚æ‚„æ‚„åœ°å°‡æ”¹å‹•è¨˜éŒ„ä¸‹ä¾†ã€‚ç•¶ä½ æäº¤æˆ–ä¿®æ”¹åˆ†æ”¯æ™‚ï¼Œreflog å°±æœƒæ›´æ–°ã€‚`git update-ref` å‘½ä»¤ä¹Ÿå¯ä»¥æ›´æ–° reflogï¼Œé€™æ˜¯åœ¨æœ¬ç« å‰é¢çš„ â€œGit Referencesâ€ éƒ¨åˆ†æˆ‘å€‘ä½¿ç”¨è©²å‘½ä»¤è€Œä¸æ˜¯æ‰‹å·¥å°‡ SHA å€¼å¯«å…¥ ref æ–‡ä»¶çš„ç†ç”±ã€‚ä»»ä½•æ™‚é–“åŸ·è¡Œ `git reflog` å‘½ä»¤å¯ä»¥æŸ¥çœ‹ç•¶å‰çš„ç‹€æ…‹ï¼š 

	$ git reflog
	1a410ef HEAD@{0}: 1a410efbd13591db07496601ebc7a059dd55cfe9: updating HEAD
	ab1afef HEAD@{1}: ab1afef80fac8e34258ff41fc1b867c702daa24b: updating HEAD

å¯ä»¥çœ‹åˆ°æˆ‘å€‘ check out çš„å…©å€‹ commit ï¼Œä½†æ²’æœ‰æ›´å¤šçš„ç›¸é—œè³‡è¨Šã€‚åŸ·è¡Œ `git log -g` æœƒè¼¸å‡º reflog çš„æ­£å¸¸æ—¥èªŒï¼Œå¾è€Œé¡¯ç¤ºæ›´å¤šæœ‰ç”¨è³‡è¨Šï¼š 

	$ git log -g
	commit 1a410efbd13591db07496601ebc7a059dd55cfe9
	Reflog: HEAD@{0} (Scott Chacon <schacon@gmail.com>)
	Reflog message: updating HEAD
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:22:37 2009 -0700

	    third commit

	commit ab1afef80fac8e34258ff41fc1b867c702daa24b
	Reflog: HEAD@{1} (Scott Chacon <schacon@gmail.com>)
	Reflog message: updating HEAD
	Author: Scott Chacon <schacon@gmail.com>
	Date:   Fri May 22 18:15:24 2009 -0700

	     modified repo a bit

çœ‹èµ·ä¾†å¼„ä¸Ÿäº†çš„ commit æ˜¯åº•ä¸‹é‚£å€‹ï¼Œé€™æ¨£åœ¨é‚£å€‹ commit ä¸Šå‰µå»ºä¸€å€‹æ–°åˆ†æ”¯å°±èƒ½æŠŠå®ƒæ¢å¾©éä¾†ã€‚æ¯”æ–¹èªªï¼Œå¯ä»¥åœ¨é‚£å€‹ commit (ab1afef) ä¸Šå‰µå»ºä¸€å€‹åç‚º `recover-branch` çš„åˆ†æ”¯ï¼š 

	$ git branch recover-branch ab1afef
	$ git log --pretty=oneline recover-branch
	ab1afef80fac8e34258ff41fc1b867c702daa24b modified repo a bit
	484a59275031909e19aadb7c92262719cfcdf19a added repo.rb
	1a410efbd13591db07496601ebc7a059dd55cfe9 third commit
	cac0cab538b970a37ea1e769cbbde608743bc96d second commit
	fdf4fc3344e67ab068f836878b6c4951e3b15f3d first commit

é…·ï¼é€™æ¨£æœ‰äº†ä¸€å€‹è·ŸåŸä¾† `master` ä¸€æ¨£çš„ `recover-branch` åˆ†æ”¯ï¼Œæœ€æ–°çš„å…©å€‹ commit åˆæ‰¾å›ä¾†äº†ã€‚ 
æ¥è‘—ï¼Œå‡è¨­å¼•èµ· commit ä¸Ÿå¤±çš„åŸå› ä¸¦æ²’æœ‰è¨˜éŒ„åœ¨ reflog ä¸­ â”€â”€ å¯ä»¥é€šéåˆªé™¤ `recover-branch` å’Œ reflog ä¾†é¡æ¯”é€™ç¨®æƒ…æ³ã€‚é€™æ¨£æœ€æ–°çš„å…©å€‹ commit ä¸æœƒè¢«ä»»ä½•æ±è¥¿å¼•ç”¨åˆ°ï¼š 

	$ git branch -D recover-branch
	$ rm -Rf .git/logs/

å› ç‚º reflog è³‡æ–™æ˜¯ä¿å­˜åœ¨ `.git/logs/` ç›®éŒ„ä¸‹çš„ï¼Œé€™æ¨£å°±æ²’æœ‰ reflog äº†ã€‚ç¾åœ¨è¦æ€æ¨£æ¢å¾© commit å‘¢ï¼Ÿè¾¦æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨ `git fsck` å·¥å…·ï¼Œè©²å·¥å…·æœƒæª¢æŸ¥å€‰åº«çš„è³‡æ–™å®Œæ•´æ€§ã€‚å¦‚æœæŒ‡å®š `--full` é¸é …ï¼Œè©²å‘½ä»¤é¡¯ç¤ºæ‰€æœ‰æœªè¢«å…¶ä»–ç‰©ä»¶å¼•ç”¨ (æŒ‡å‘) çš„æ‰€æœ‰ç‰©ä»¶ï¼š 

	$ git fsck --full
	dangling blob d670460b4b4aece5915caf5c68d12f560a9fe3e4
	dangling commit ab1afef80fac8e34258ff41fc1b867c702daa24b
	dangling tree aea790b9a58f6cf6f2804eeac9f0abbe9631e4c9
	dangling blob 7108f7ecb345ee9d0084193f147cdad4d2998293

æœ¬ä¾‹ä¸­ï¼Œå¯ä»¥å¾ dangling commit æ‰¾åˆ°ä¸Ÿå¤±äº†çš„ commitã€‚ç”¨ç›¸åŒçš„æ–¹æ³•å°±å¯ä»¥æ¢å¾©å®ƒï¼Œå³å‰µå»ºä¸€å€‹æŒ‡å‘è©² SHA çš„åˆ†æ”¯ã€‚ 

## ç§»é™¤ç‰©ä»¶

Git æœ‰è¨±å¤šéäººä¹‹è™•ï¼Œä¸éæœ‰ä¸€å€‹åŠŸèƒ½æœ‰æ™‚å»æœƒå¸¶ä¾†å•é¡Œï¼š`git clone` æœƒå°‡åŒ…å«æ¯ä¸€å€‹æª”çš„æ‰€æœ‰æ­·å²ç‰ˆæœ¬çš„æ•´å€‹å°ˆæ¡ˆä¸‹è¼‰ä¸‹ä¾†ã€‚å¦‚æœå°ˆæ¡ˆåŒ…å«çš„åƒ…åƒ…æ˜¯åŸå§‹ç¨‹å¼ç¢¼çš„è©±é€™ä¸¦æ²’æœ‰ä»€éº¼å£è™•ï¼Œç•¢ç«Ÿ Git å¯ä»¥éå¸¸é«˜æ•ˆåœ°å£“ç¸®æ­¤é¡è³‡æ–™ã€‚ä¸éå¦‚æœæœ‰äººåœ¨æŸå€‹æ™‚åˆ»å¾€å°ˆæ¡ˆä¸­æ·»åŠ äº†ä¸€å€‹éå¸¸å¤§çš„æª”ï¼Œå³ä¾¿ä»–åœ¨å¾Œä¾†çš„æäº¤ä¸­å°‡æ­¤æª”åˆªæ‰äº†ï¼Œæ‰€æœ‰çš„ç°½å‡ºéƒ½æœƒä¸‹è¼‰é€™å€‹å¤§æª”ã€‚å› ç‚ºæ­·å²è¨˜éŒ„ä¸­å¼•ç”¨äº†é€™å€‹æª”ï¼Œå®ƒæœƒä¸€ç›´å­˜åœ¨è‘—ã€‚ 

ç•¶ä½ å°‡ Subversion æˆ– Perforce å€‰åº«è½‰æ›å°å…¥è‡³ Git æ™‚é€™æœƒæˆç‚ºä¸€å€‹å¾ˆåš´é‡çš„å•é¡Œã€‚åœ¨æ­¤é¡ç³»çµ±ä¸­ï¼Œ(ç°½å‡ºæ™‚) ä¸æœƒä¸‹è¼‰æ•´å€‹å€‰åº«æ­·å²ï¼Œæ‰€ä»¥é€™ç¨®æƒ…å½¢ä¸å¤§æœƒæœ‰ä¸è‰¯å¾Œæœã€‚å¦‚æœä½ å¾å…¶ä»–ç³»çµ±å°å…¥äº†ä¸€å€‹å€‰åº«ï¼Œæˆ–æ˜¯ç™¼è¦ºä¸€å€‹å€‰åº«çš„å°ºå¯¸é è¶…å‡ºé è¨ˆï¼Œå¯ä»¥ç”¨ä¸‹é¢çš„æ–¹æ³•æ‰¾åˆ°ä¸¦ç§»é™¤å¤§ (å°ºå¯¸) ç‰©ä»¶ã€‚ 

è­¦å‘Šï¼šæ­¤æ–¹æ³•æœƒç ´å£æäº¤æ­·å²ã€‚ç‚ºäº†ç§»é™¤å°ä¸€å€‹å¤§æª”çš„å¼•ç”¨ï¼Œå¾æœ€æ—©åŒ…å«è©²å¼•ç”¨çš„ tree ç‰©ä»¶é–‹å§‹ä¹‹å¾Œçš„æ‰€æœ‰ commit ç‰©ä»¶éƒ½æœƒè¢«é‡å¯«ã€‚å¦‚æœåœ¨å‰›å°å…¥ä¸€å€‹å€‰åº«ä¸¦åœ¨å…¶ä»–äººåœ¨æ­¤åŸºç¤ä¸Šé–‹å§‹å·¥ä½œä¹‹å‰é€™éº¼åšï¼Œé‚£æ²’æœ‰ä»€éº¼å•é¡Œ â”€â”€ å¦å‰‡ä½ ä¸å¾—ä¸é€šçŸ¥æ‰€æœ‰å”ä½œè€… (è²¢ç»è€…) å»è¡åˆä½ æ–°ä¿®æ”¹çš„ commit ã€‚ 

ç‚ºäº†æ¼”ç¤ºé€™é»ï¼Œå¾€ test å€‰åº«ä¸­åŠ å…¥ä¸€å€‹å¤§æª”ï¼Œç„¶å¾Œåœ¨ä¸‹æ¬¡æäº¤æ™‚å°‡å®ƒåˆªé™¤ï¼Œæ¥è‘—æ‰¾åˆ°ä¸¦å°‡é€™å€‹æª”å¾å€‰åº«ä¸­æ°¸ä¹…åˆªé™¤ã€‚é¦–å…ˆï¼ŒåŠ ä¸€å€‹å¤§æª”é€²å»ï¼š 

	$ curl http://kernel.org/pub/software/scm/git/git-1.6.3.1.tar.bz2 > git.tbz2
	$ git add git.tbz2
	$ git commit -am 'added git tarball'
	[master 6df7640] added git tarball
	 1 files changed, 0 insertions(+), 0 deletions(-)
	 create mode 100644 git.tbz2

å–”ï¼Œä½ ä¸¦ä¸æƒ³å¾€å°ˆæ¡ˆä¸­åŠ é€²ä¸€å€‹é€™éº¼å¤§çš„ tar åŒ…ã€‚æœ€å¾Œé‚„æ˜¯å»æ‰å®ƒï¼š 

	$ git rm git.tbz2
	rm 'git.tbz2'
	$ git commit -m 'oops - removed large tarball'
	[master da3f30d] oops - removed large tarball
	 1 files changed, 0 insertions(+), 0 deletions(-)
	 delete mode 100644 git.tbz2

å°å€‰åº«é€²è¡Œ `gc` æ“ä½œï¼Œä¸¦æŸ¥çœ‹ä½”ç”¨äº†ç©ºé–“ï¼š 

	$ git gc
	Counting objects: 21, done.
	Delta compression using 2 threads.
	Compressing objects: 100% (16/16), done.
	Writing objects: 100% (21/21), done.
	Total 21 (delta 3), reused 15 (delta 1)

å¯ä»¥åŸ·è¡Œ `count-objects` ä»¥æŸ¥çœ‹ä½¿ç”¨äº†å¤šå°‘ç©ºé–“ï¼š 

	$ git count-objects -v
	count: 4
	size: 16
	in-pack: 21
	packs: 1
	size-pack: 2016
	prune-packable: 0
	garbage: 0

`size-pack` æ˜¯ä»¥ KB ç‚ºå–®ä½è¡¨ç¤ºçš„ packfiles çš„å¤§å°ï¼Œå› æ­¤å·²ç¶“ä½¿ç”¨äº† 2MB ã€‚è€Œåœ¨é€™æ¬¡æäº¤ä¹‹å‰åƒ…ç”¨äº† 2K å·¦å³ â”€â”€ é¡¯ç„¶åœ¨é€™æ¬¡æäº¤æ™‚åˆªé™¤æª”ä¸¦æ²’æœ‰çœŸæ­£å°‡å…¶å¾æ­·å²è¨˜éŒ„ä¸­åˆªé™¤ã€‚æ¯ç•¶æœ‰äººè¤‡è£½é€™å€‹å€‰åº«å»å–å¾—é€™å€‹å°å°ˆæ¡ˆæ™‚ï¼Œéƒ½ä¸å¾—ä¸è¤‡è£½æ‰€æœ‰ 2MB è³‡æ–™ï¼Œè€Œé€™åƒ…åƒ…å› ç‚ºä½ æ›¾ç¶“ä¸å°å¿ƒåŠ äº†å€‹å¤§æª”ã€‚è®“æˆ‘å€‘ä¾†è§£æ±ºé€™å€‹å•é¡Œã€‚ 

é¦–å…ˆè¦æ‰¾å‡ºé€™å€‹æª”ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œä½ çŸ¥é“æ˜¯å“ªå€‹æ–‡ä»¶ã€‚å‡è¨­ä½ ä¸¦ä¸çŸ¥é“é€™ä¸€é»ï¼Œè¦å¦‚ä½•æ‰¾å‡ºå“ªå€‹ (äº›) æ–‡ä»¶ä½”ç”¨äº†é€™éº¼å¤šçš„ç©ºé–“ï¼Ÿå¦‚æœåŸ·è¡Œ `git gc`ï¼Œæ‰€æœ‰ç‰©ä»¶æœƒå­˜å…¥ä¸€å€‹ packfile æª”ï¼›åŸ·è¡Œå¦ä¸€å€‹åº•å±¤å‘½ä»¤ `git verify-pack` ä»¥è­˜åˆ¥å‡ºå¤§ç‰©ä»¶ï¼Œå°è¼¸å‡ºçš„ç¬¬ä¸‰æ¬„è³‡è¨Šå³æª”æ¡ˆå¤§å°é€²è¡Œæ’åºï¼Œé‚„å¯ä»¥å°‡è¼¸å‡ºå®šå‘(pipe)åˆ° `tail` å‘½ä»¤ï¼Œå› ç‚ºä½ åªé—œå¿ƒæ’åœ¨æœ€å¾Œçš„é‚£å¹¾å€‹æœ€å¤§çš„æª”ï¼š 

	$ git verify-pack -v .git/objects/pack/pack-3f8c0...bb.idx | sort -k 3 -n | tail -3
	e3f094f522629ae358806b17daf78246c27c007b blob   1486 734 4667
	05408d195263d853f09dca71d55116663690c27c blob   12908 3478 1189
	7a9eb2fba2b1811321254ac360970fc169ba2330 blob   2056716 2056872 5401

æœ€åº•ä¸‹é‚£å€‹å°±æ˜¯é‚£å€‹å¤§æª”ï¼š2MB ã€‚è¦æŸ¥çœ‹é€™åˆ°åº•æ˜¯å“ªå€‹æª”ï¼Œå¯ä»¥ä½¿ç”¨ç¬¬ 7 ç« ä¸­å·²ç¶“ç°¡å–®ä½¿ç”¨éçš„ `rev-list` å‘½ä»¤ã€‚è‹¥çµ¦ `rev-list` å‘½ä»¤å‚³å…¥ `--objects` é¸é …ï¼Œå®ƒæœƒåˆ—å‡ºæ‰€æœ‰ commit SHA å€¼ï¼Œblob SHA å€¼åŠç›¸æ‡‰çš„æª”è·¯å¾‘ã€‚å¯ä»¥é€™æ¨£æŸ¥çœ‹ blob çš„æª”æ¡ˆåï¼š 

	$ git rev-list --objects --all | grep 7a9eb2fb
	7a9eb2fba2b1811321254ac360970fc169ba2330 git.tbz2

æ¥ä¸‹ä¾†è¦å°‡è©²æª”å¾æ­·å²è¨˜éŒ„çš„æ‰€æœ‰ tree ä¸­ç§»é™¤ã€‚å¾ˆå®¹æ˜“æ‰¾å‡ºå“ªäº› commit ä¿®æ”¹äº†é€™å€‹æª”ï¼š 

	$ git log --pretty=oneline --branches -- git.tbz2
	da3f30d019005479c99eb4c3406225613985a1db oops - removed large tarball
	6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 added git tarball

å¿…é ˆé‡å¯«å¾ `6df76` é–‹å§‹çš„æ‰€æœ‰ commit æ‰èƒ½å°‡æª”å¾ Git æ­·å²ä¸­å®Œå…¨ç§»é™¤ã€‚é€™éº¼åšéœ€è¦ç”¨åˆ°ç¬¬ 6 ç« ä¸­ç”¨éçš„ `filter-branch` å‘½ä»¤ï¼š 

	$ git filter-branch --index-filter \
	   'git rm --cached --ignore-unmatch git.tbz2' -- 6df7640^..
	Rewrite 6df764092f3e7c8f5f94cbe08ee5cf42e92a0289 (1/2)rm 'git.tbz2'
	Rewrite da3f30d019005479c99eb4c3406225613985a1db (2/2)
	Ref 'refs/heads/master' was rewritten

`--index-filter` é¸é …é¡ä¼¼æ–¼ç¬¬ 6 ç« ä¸­ä½¿ç”¨çš„ `--tree-filter` é¸é …ï¼Œä½†é€™è£¡ä¸æ˜¯å‚³å…¥ä¸€å€‹å‘½ä»¤å»ä¿®æ”¹ç£ç¢Ÿä¸Š checked out çš„æª”ï¼Œè€Œæ˜¯ä¿®æ”¹æš«å­˜å€åŸŸæˆ–ç´¢å¼•ã€‚ä¸èƒ½ç”¨ `rm file` å‘½ä»¤ä¾†åˆªé™¤ä¸€å€‹ç‰¹å®šæª”ï¼Œè€Œæ˜¯å¿…é ˆç”¨ `git rm --cached` ä¾†åˆªé™¤å®ƒ â”€â”€ ä¹Ÿå°±æ˜¯èªªï¼Œå¾ç´¢å¼•è€Œä¸æ˜¯å¾ç£ç¢Ÿä¸Šåˆªé™¤å®ƒã€‚é€™æ¨£åšæ˜¯å‡ºæ–¼é€Ÿåº¦è€ƒæ…® â”€â”€ ç”±æ–¼ Git åœ¨åŸ·è¡Œä½ çš„ filter ä¹‹å‰ç„¡éœ€å°‡æ‰€æœ‰ç‰ˆæœ¬ç°½å‡ºåˆ°ç£ç‰‡ä¸Šï¼Œé€™å€‹æ“ä½œæœƒå¿«å¾—å¤šã€‚ä¹Ÿå¯ä»¥ç”¨ `--tree-filter` ä¾†å®Œæˆç›¸åŒçš„æ“ä½œã€‚`git rm` çš„ `--ignore-unmatch` é¸é …æŒ‡å®šç•¶ä½ è©¦åœ–åˆªé™¤çš„å…§å®¹ä¸¦ä¸å­˜åœ¨æ™‚ä¸é¡¯ç¤ºéŒ¯èª¤ã€‚æœ€å¾Œï¼Œå› ç‚ºä½ æ¸…æ¥šå•é¡Œæ˜¯å¾å“ªå€‹ commit é–‹å§‹çš„ï¼Œä½¿ç”¨ `filter-branch` é‡å¯«è‡ª `6df7640` é€™å€‹ commit é–‹å§‹çš„æ‰€æœ‰æ­·å²è¨˜éŒ„ã€‚ä¸é€™éº¼åšçš„è©±æœƒé‡å¯«æ‰€æœ‰æ­·å²è¨˜éŒ„ï¼ŒèŠ±è²»ä¸å¿…è¦çš„æ›´å¤šæ™‚é–“ã€‚ 

ç¾åœ¨æ­·å²è¨˜éŒ„ä¸­å·²ç¶“ä¸åŒ…å«å°é‚£å€‹æª”çš„å¼•ç”¨äº†ã€‚ä¸é reflog ä»¥åŠåŸ·è¡Œ `filter-branch` æ™‚ Git å¾€ `.git/refs/original` æ·»åŠ çš„ä¸€äº› refs ä¸­ä»æœ‰å°å®ƒçš„å¼•ç”¨ï¼Œå› æ­¤éœ€è¦å°‡é€™äº›å¼•ç”¨åˆªé™¤ä¸¦å°å€‰åº«é€²è¡Œ repack æ“ä½œã€‚åœ¨é€²è¡Œ repack å‰éœ€è¦å°‡æ‰€æœ‰å°é€™äº› commits çš„å¼•ç”¨å»é™¤ï¼š 

	$ rm -Rf .git/refs/original
	$ rm -Rf .git/logs/
	$ git gc
	Counting objects: 19, done.
	Delta compression using 2 threads.
	Compressing objects: 100% (14/14), done.
	Writing objects: 100% (19/19), done.
	Total 19 (delta 3), reused 16 (delta 1)

çœ‹ä¸€ä¸‹ç¯€çœäº†å¤šå°‘ç©ºé–“ã€‚ 

	$ git count-objects -v
	count: 8
	size: 2040
	in-pack: 19
	packs: 1
	size-pack: 7
	prune-packable: 0
	garbage: 0

repack å¾Œå€‰åº«çš„å¤§å°æ¸›å°åˆ°äº† 7K ï¼Œé å°æ–¼ä¹‹å‰çš„ 2MB ã€‚å¾ size å€¼å¯ä»¥çœ‹å‡ºå¤§æª”ç‰©ä»¶é‚„åœ¨é¬†æ•£ç‰©ä»¶ä¸­ï¼Œå…¶å¯¦ä¸¦æ²’æœ‰æ¶ˆå¤±ï¼Œä¸éé€™æ²’æœ‰é—œä¿‚ï¼Œé‡è¦çš„æ˜¯åœ¨å†é€²è¡Œæ¨é€æˆ–è¤‡è£½ï¼Œé€™å€‹ç‰©ä»¶ä¸æœƒå†å‚³é€å‡ºå»ã€‚å¦‚æœçœŸçš„è¦å®Œå…¨æŠŠé€™å€‹ç‰©ä»¶åˆªé™¤ï¼Œå¯ä»¥é‹è¡Œ `git prune --expire` å‘½ä»¤ã€‚ 
